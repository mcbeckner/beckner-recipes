<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beckner Recipes</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3565/3565418.png">
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <style>
        /* --- CSS Custom Properties --- */
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --header-color: #2c3e50;
            --container-bg: #fff;
            --border-color: #e0e0e0;
            --card-bg: #fff;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --button-primary: #007bff;
            --button-primary-hover: #0056b3;
            --button-danger: #dc3545;
            --meal-plan-day-bg: #fff;
            --meal-plan-header-bg: #007bff;
            --meal-plan-header-text: #fff;
            --modal-bg: #fff;
            --fav-color-filled: #ff4d4d;
            --fav-color-empty: #cccccc;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --header-color: #61dafb;
            --container-bg: #2d2d2d;
            --border-color: #444;
            --card-bg: #383838;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --button-primary: #61dafb;
            --button-primary-hover: #21a1f1;
            --meal-plan-day-bg: #383838;
            --meal-plan-header-bg: #444;
            --meal-plan-header-text: #61dafb;
            --modal-bg: #2d2d2d;
            --fav-color-filled: #ff7f7f;
            --fav-color-empty: #555555;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background-color: var(--container-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow-color); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .header-actions { display: flex; gap: 10px; }
        h1 { margin: 0; font-size: 1.8rem; color: var(--header-color); }

        /* Buttons & Inputs */
        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
        .primary-btn { background: var(--button-primary); color: white; }
        .icon-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); font-size: 1.2rem; padding: 6px 12px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); box-sizing: border-box; margin-bottom: 10px; }

        .view-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .view-toggle button { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .view-toggle button.active { background: var(--button-primary); color: white; border-color: var(--button-primary); }

        /* Tag Pill Styles */
        .tag-input-wrapper { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; background: var(--card-bg); }
        .tag-input-wrapper input { flex-grow: 1; border: none; padding: 0; margin: 0; background: transparent; }
        .tag-pill { display: inline-flex; align-items: center; background: var(--button-primary); color: white; padding: 4px 8px; border-radius: 16px; font-size: 0.85rem; }
        .tag-pill .remove-tag { margin-left: 5px; cursor: pointer; font-weight: bold; color: rgba(255,255,255,0.7); }
        .tag-pill .remove-tag:hover { color: white; }

        .tag-filter-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag-filter-btn { background: var(--card-bg); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .tag-filter-btn.active { background: var(--button-primary); color: white; border-color: var(--button-primary); }


        /* Grid & Cards */
        #recipeList, #favoritesList { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .recipe-item { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px var(--shadow-color); position: relative; cursor: pointer; border: 1px solid var(--border-color); }
        .recipe-item:hover { transform: translateY(-4px); }
        .recipe-item img { width: 100%; height: 180px; object-fit: cover; }
        .recipe-item h3 { padding: 15px; margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .card-btn { background: rgba(255,255,255,0.95); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-btn.fav.active { color: var(--fav-color-filled); }
        .card-btn.delete { color: var(--button-danger); }


        /* Meal Plan */
        .meal-plan-calendar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .meal-day-column { background: var(--meal-plan-day-bg); border-radius: 10px; border: 1px solid var(--border-color); overflow: hidden; min-height: 200px; display: flex; flex-direction: column; }
        .meal-day-column.drag-over { box-shadow: 0 0 0 3px var(--button-primary); }
        .day-header { background: var(--meal-plan-header-bg); color: var(--meal-plan-header-text); padding: 8px; text-align: center; font-weight: bold; position: relative; }
        .add-meal-day-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .day-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .meal-card { background: var(--card-bg); border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px var(--shadow-color); position: relative; cursor: pointer; border: 1px solid var(--border-color); }
        .meal-card img { width: 100%; height: 80px; object-fit: cover; display: block; }
        .meal-card-title { padding: 6px; font-size: 0.85rem; font-weight: 500; }
        .remove-meal-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: none; }
        .meal-card.dragging { opacity: 0.5; border: 2px dashed var(--button-primary); }


        /* Shopping List */
        .shopping-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .aisle-group {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .aisle-header {
            background: var(--meal-plan-header-bg);
            color: var(--meal-plan-header-text);
            padding: 8px 12px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .aisle-items {
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }
        .shopping-item { display: flex; align-items: flex-start; background: var(--bg-color); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .shopping-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; }
        .shopping-item.checked { text-decoration: line-through; opacity: 0.6; }
        .shopping-list-controls { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }


        /* Nutrition */
        .nutrition-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .nutri-pill { text-align: center; background: var(--bg-color); padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .nutri-pill span { display: block; font-size: 0.8rem; opacity: 0.8; }
        .nutri-pill strong { font-size: 1.1rem; color: var(--button-primary); }

        /* Unit Converter */
        .conversion-tool {
            padding: 15px;
            background: var(--bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .conversion-tool h4 { margin: 0; width: 100%; font-size: 1rem; color: var(--header-color); }
        .conversion-tool input, .conversion-tool select {
            flex: 1; /* Allow them to grow */
            min-width: 80px; /* Minimum width for readability */
            margin-bottom: 0; /* Override default input margin */
            font-size: 0.9rem;
            padding: 6px 8px;
        }
        .conversion-tool span { font-weight: bold; }
        .conversion-tool button { padding: 6px 10px; font-size: 0.9rem; }


        /* Modals */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.75); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--modal-bg); border-radius: 12px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .close-modal { background: none; border: none; font-size: 1.8rem; color: var(--text-color); cursor: pointer; padding: 0; line-height: 1; }

        /* Split View (Detail) */
        #detailModal .modal-content {
            height: 90vh;
            display: flex;
            flex-direction: column; 
        }
        .split-view-container {
            display: flex;
            flex: 1; 
            overflow: hidden; 
            flex-direction: column; /* Default for very small screens (e.g. phone portrait) */
        }

        /* Responsive Breakpoint for Split View - 769px and wider will show side-by-side */
        @media (min-width: 769px) {
            .split-view-container {
                flex-direction: row; /* Split left/right */
            }
            .split-col.left {
                flex: 0 0 35%; /* Fixed width for left column */
                border-right: 1px solid var(--border-color);
                background: rgba(0,0,0,0.02);
            }
            .split-col.right {
                flex: 1; /* Remaining width for right column */
            }
        }
        /* Ensure independent scrolling for columns regardless of width */
        .split-col {
            overflow-y: auto;
            padding: 20px 25px;
        }

        .ingredient-list li { padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; }
        .ingredient-list li.checked { text-decoration: line-through; opacity: 0.5; }
        .stars span { font-size: 1.5rem; cursor: pointer; color: #ccc; }
        .stars span.filled { color: #ffc107; }
        
        /* Floating Timer */
        #timerIndicator { position: fixed; bottom: 25px; right: 25px; background: var(--header-color); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; display: none; z-index: 2000; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h1>Beckner Recipes</h1>
        <div class="header-actions">
            <button class="icon-btn" id="customTimerBtn">‚è± Timer</button>
            <button class="icon-btn" id="darkModeBtn">üåô</button>
        </div>
    </div>

    <div class="view-toggle">
        <button id="viewRecipesBtn" class="active">Recipes</button>
        <button id="viewMealPlanBtn">Meal Plan</button>
        <button id="viewShoppingBtn">Shopping List</button>
        <button id="viewFavoritesBtn">Favorites</button>
    </div>

    <!-- RECIPE CONTROLS -->
    <div id="recipeControls" class="top-bar" style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
        <button class="primary-btn" id="openAddModalBtn">+ Add Recipe</button>
        <input type="text" id="searchInput" placeholder="Search..." style="margin:0; flex-grow:1;">
        
        <!-- TAG FILTER -->
        <div id="tagFilterContainer" class="tag-filter-container">
            <button class="tag-filter-btn" data-tag="all" id="allTagsBtn">All Tags</button>
        </div>
    </div>

    <!-- VIEWS -->
    <div id="recipesView">
        <div id="recipeList"></div>
        <p id="emptyMessage" style="text-align:center; display:none; padding:20px;">No recipes found.</p>
    </div>

    <div id="mealPlanView" style="display: none;">
        <div style="text-align:center; margin-bottom:15px;">
            <select id="mealPlanWeekSelect" style="width: 200px; padding: 8px;">
                <option value="current">Current Week</option>
                <option value="next">Next Week</option>
            </select>
        </div>
        <div id="mealPlanGrid" class="meal-plan-calendar"></div>
    </div>

    <div id="shoppingView" style="display: none;">
        <div class="shopping-list-controls">
            <button class="primary-btn" id="checkAllBtn">Check All</button>
            <button class="primary-btn" id="clearCheckedBtn">Clear Checked</button>
        </div>
        <div id="shoppingListContainer" class="shopping-list-container"></div>
    </div>

    <div id="favoritesView" style="display: none;">
        <div id="favoritesList"></div>
        <p id="emptyFavMessage" style="text-align:center; display:none; padding:20px;">No favorites yet.</p>
    </div>
</div>

<div id="timerIndicator">
    <span id="timerText">Timer: 00:00</span>
    <button id="cancelTimerBtn" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">‚úï</button>
</div>

<!-- ADD/EDIT MODAL -->
<div id="recipeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; display:block; padding:0;">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin:0;">Add Recipe</h2>
            <button class="close-modal close-add-modal">&times;</button>
        </div>
        <div style="padding: 20px;">
            <!-- JSON-LD IMPORT -->
            <div style="display:flex; gap:10px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed var(--border-color);">
                <textarea id="inpImportJson" placeholder="Paste Recipe JSON-LD Here (from page source)" rows="3" style="margin:0; flex-grow:1;"></textarea>
                <button type="button" id="btnImportJson" class="primary-btn" style="white-space:nowrap;">Parse JSON</button>
            </div>

            <form id="recipeForm">
                <input type="hidden" id="editId">
                <input type="text" id="inpTitle" placeholder="Recipe Title" required>
                <input type="url" id="inpSource" placeholder="Source URL">
                
                <!-- TAGS INPUT -->
                <label style="margin-top:10px; display:block; font-weight:bold;">Tags (comma-separated):</label>
                <input type="text" id="inpTags" placeholder="e.g., Dinner, Quick, Vegetarian" list="availableTags">
                <datalist id="availableTags"></datalist>

                <label style="margin-top:10px; display:block; font-weight:bold;">Nutrition (Optional)</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="number" id="inpCal" placeholder="Cals" style="margin:0;">
                    <input type="number" id="inpPro" placeholder="Prot (g)" style="margin:0;">
                    <input type="number" id="inpCarb" placeholder="Carbs (g)" style="margin:0;">
                    <input type="number" id="inpFat" placeholder="Fat (g)" style="margin:0;">
                </div>

                <div style="display:flex; gap:10px; align-items: center; margin-bottom:10px; margin-top:10px;">
                    <input type="number" id="inpServings" placeholder="Servings" value="4" style="width:100px;">
                    <div class="stars" id="inpRating" data-val="0">
                        <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
                    </div>
                </div>

                <label>Image:</label>
                <input type="file" id="inpImage" accept="image/*">
                
                <label>Ingredients (one per line, optionally add // Aisle at end):</label>
                <textarea id="inpIngredients" rows="6" required placeholder="e.g.&#10;2 cups Flour // Baking&#10;1 tsp Salt // Spices"></textarea>
                
                <label>Instructions (one per line):</label>
                <textarea id="inpInstructions" rows="6" required placeholder="e.g.&#10;Preheat oven to 350&#10;Mix dry ingredients"></textarea>

                <button type="submit" class="primary-btn" id="btnSave" style="width:100%;">Save Recipe</button>
            </form>
        </div>
    </div>
</div>

<!-- SIMPLE SELECT MODAL FOR MEAL PLAN -->
<div id="selectRecipeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px; height:auto; padding:20px; display:block;">
        <h3 style="margin-top:0;">Add to <span id="targetDayName"></span></h3>
        <select id="mealPlanSelectDropdown" style="width:100%; padding:10px; font-size:1rem; margin-bottom:15px;"></select>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancelSelectBtn" style="background:none; border:1px solid #ccc;">Cancel</button>
            <button id="confirmSelectBtn" class="primary-btn">Add to Day</button>
        </div>
    </div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="detTitle" style="margin:0;">Recipe Title</h2>
            <div style="display:flex; gap:10px;">
                 <button id="btnDeleteRecipeDetail" class="primary-btn" style="background: var(--button-danger); padding:4px 10px; font-size:0.8rem;">Delete</button>
                 <button class="close-modal close-detail-modal">&times;</button>
            </div>
        </div>
        
        <div class="detail-meta-bar">
            <!-- TAGS DISPLAY -->
            <div id="detTags" class="tag-filter-container">
                <!-- Tags will be dynamically inserted here -->
            </div>
            <div class="stars" id="detRating">
                <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
            </div>
            <a id="detSourceLink" href="#" target="_blank" class="source-link" style="display:none;">View Source ‚Üó</a>
            <div style="margin-left: auto; display:flex; gap:10px;">
                <button id="btnEditRecipe" class="primary-btn" style="padding:4px 10px; font-size:0.8rem;">Edit</button>
                <button id="btnPrint" class="primary-btn" style="padding:4px 10px; font-size:0.8rem;">Print</button>
            </div>
        </div>

        <div class="split-view-container">
            <div class="split-col left">
                <div id="detNutrition" class="nutrition-grid" style="display:none;">
                    <div class="nutri-pill"><span>Calories</span><strong id="valCal">0</strong></div>
                    <div class="nutri-pill"><span>Protein</span><strong id="valPro">0g</strong></div>
                    <div class="nutri-pill"><span>Carbs</span><strong id="valCarb">0g</strong></div>
                    <div class="nutri-pill"><span>Fat</span><strong id="valFat">0g</strong></div>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                    <label style="font-size:0.85rem; font-weight:bold;">Yields: <span id="detOrigServings"></span></label>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                        <span style="font-size:0.9rem;">Scale to:</span>
                        <input type="number" id="detDesiredServings" style="width:60px; margin:0; text-align:center;">
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3 style="border-bottom: 2px solid var(--header-color); padding-bottom:5px;">Ingredients</h3>
                    <ul id="detIngredients" class="ingredient-list"></ul>
                </div>
            </div>
            <div class="split-col right">
                <!-- UNIT CONVERTER -->
                <div class="conversion-tool">
                    <h4>Unit Converter</h4>
                    <input type="number" id="convertInputQty" value="1" min="0.01" step="0.01">
                    <select id="convertInputUnit">
                        <option value="tsp">tsp</option>
                        <option value="tbsp">tbsp</option>
                        <option value="cup">cup</option>
                        <option value="floz">fl oz</option>
                        <option value="ml">ml</option>
                        <option value="l">L</option>
                        <option value="g">g</option>
                        <option value="oz_w">oz (weight)</option>
                        <option value="lb">lb</option>
                        <option value="kg">kg</option>
                    </select>
                    <span>=</span>
                    <span id="convertOutputQty">0</span>
                    <select id="convertOutputUnit">
                        <option value="tbsp">tbsp</option>
                        <option value="cup">cup</option>
                        <option value="floz">fl oz</option>
                        <option value="ml">ml</option>
                        <option value="l">L</option>
                        <option value="g">g</option>
                        <option value="oz_w">oz (weight)</option>
                        <option value="lb">lb</option>
                        <option value="kg">kg</option>
                        <option value="tsp">tsp</option>
                    </select>
                    <button class="primary-btn" id="convertBtn">Convert</button>
                </div>

                <h3 style="border-bottom: 2px solid var(--header-color); padding-bottom:5px; margin-top:0;">Instructions</h3>
                <div id="detInstructions"></div>
                <h3 style="margin-top:30px;">Notes</h3>
                <textarea id="detNotes" placeholder="Personal notes..." style="min-height:100px;"></textarea>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); }); }

    const firebaseConfig = {
        apiKey: "AIzaSyA_5czSGHpYR8ZHMuB41mnIf5gL8zvLS6M",
        authDomain: "becknerrecipes.firebaseapp.com",
        projectId: "becknerrecipes",
        storageBucket: "becknerrecipes.firebasestorage.app",
        messagingSenderId: "563764688388",
        appId: "1:563764688388:web:dc5df2823ebcf0e1666751",
        measurementId: "G-SEC7ENVK7Y"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); 

    // --- STATE ---
    let recipes = [], favorites = [], mealPlan = {};
    let allTags = []; 
    let selectedTagsFilter = new Set(); 
    let currentImageFile = null, activeRecipeId = null, currentTimer = null;

    // --- INIT ---
    async function init() {
        console.log("App initializing...");
        await loadGlobalData();
        await loadRecipes();    
        renderTagFilters(); // Render tags instead of categories
        showView('recipes'); 
        if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
        // Populate initial unit converter selects
        populateUnitSelects();
        console.log("App initialized.");
    }

    async function loadGlobalData() {
        try {
            console.log("Loading global data (favorites, mealPlan, tags)...");
            const [favSnap, planSnap, tagsSnap] = await Promise.all([
                getDoc(doc(db, 'appData', 'favorites')),
                getDoc(doc(db, 'appData', 'mealPlan')),
                getDoc(doc(db, 'appData', 'tags')) // Load tags instead of categories
            ]);
            favorites = favSnap.exists() ? (favSnap.data().ids || []) : [];
            mealPlan = planSnap.exists() ? (planSnap.data().plan || {}) : {};
            allTags = tagsSnap.exists() ? (tagsSnap.data().list || ['Breakfast', 'Lunch', 'Dinner', 'Dessert', 'Snacks']).sort() : ['Breakfast', 'Lunch', 'Dinner', 'Dessert', 'Snacks'].sort();
            console.log("Global data loaded.");
        } catch(e) { 
            console.error("Error loading global data. Initializing defaults:", e);
            favorites = [];
            mealPlan = {};
            allTags = ['Breakfast', 'Lunch', 'Dinner', 'Dessert', 'Snacks'].sort();
        }
    }

    async function loadRecipes() {
        try {
            console.log("Loading recipes...");
            const snap = await getDocs(collection(db, 'recipes'));
            recipes = snap.docs.map(d => {
                const recipeData = d.data();
                // IMPORTANT: Data migration/standardization on load
                // If an old recipe has 'category' (string), convert it to 'tags' (array)
                if (recipeData.category && !recipeData.tags) {
                    console.log(`Migrating category "${recipeData.category}" to tags for recipe ${d.id}`);
                    recipeData.tags = [recipeData.category];
                    // You might want to remove the old 'category' field from Firestore if this is a one-time migration
                    // For now, just deleting it from the local object.
                    delete recipeData.category; 
                } else if (!recipeData.tags) {
                    recipeData.tags = [];
                }
                return { id: d.id, ...recipeData };
            });
            console.log(`Loaded ${recipes.length} recipes.`);
        } catch(e) { console.error("Failed to load recipes:", e); }
    }

    // --- TAG RENDERING AND MANAGEMENT ---
    function renderTagFilters() {
        const tagFilterContainer = document.getElementById('tagFilterContainer');
        tagFilterContainer.innerHTML = ''; // Clear previous buttons
        
        // "All Tags" button
        const allTagsBtn = document.createElement('button');
        allTagsBtn.className = `tag-filter-btn ${selectedTagsFilter.size === 0 ? 'active' : ''}`;
        allTagsBtn.textContent = 'All Tags';
        allTagsBtn.onclick = () => {
            selectedTagsFilter.clear();
            renderTagFilters();
            renderRecipeList();
        };
        tagFilterContainer.appendChild(allTagsBtn);

        // Individual tag buttons
        allTags.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = `tag-filter-btn ${selectedTagsFilter.has(tag) ? 'active' : ''}`;
            btn.textContent = tag;
            btn.onclick = () => {
                if (selectedTagsFilter.has(tag)) {
                    selectedTagsFilter.delete(tag);
                } else {
                    selectedTagsFilter.add(tag);
                }
                renderTagFilters(); // Re-render to update active state
                renderRecipeList();
            };
            tagFilterContainer.appendChild(btn);
        });

        // Also update datalist for input tags (for autocompletion)
        const availableTagsDatalist = document.getElementById('availableTags');
        availableTagsDatalist.innerHTML = '';
        allTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            availableTagsDatalist.appendChild(option);
        });
    }

    async function saveGlobalTags() {
        try {
            await setDoc(doc(db, 'appData', 'tags'), { list: allTags });
            renderTagFilters(); // Re-render tag filter buttons and datalist
            console.log("Tags saved to Cloud.");
        } catch(e) { console.error("Failed to save tags to Cloud:", e); }
    }

    // --- RECIPE LIST RENDERING ---
    function renderRecipeList() {
        const container = document.getElementById('recipeList');
        container.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        const filtered = recipes.filter(r => {
            const matchesSearch = !term || r.title.toLowerCase().includes(term) || (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(term)));
            
            // Tag filtering: if no tags selected, all pass. If tags selected, recipe must have AT LEAST ONE of the selected tags.
            const matchesTags = selectedTagsFilter.size === 0 || r.tags.some(tag => selectedTagsFilter.has(tag));
            
            return matchesSearch && matchesTags;
        });
        document.getElementById('emptyMessage').style.display = filtered.length ? 'none' : 'block';
        filtered.forEach(r => container.appendChild(createRecipeCard(r)));
    }
    
    function renderFavoritesList() {
        const container = document.getElementById('favoritesList');
        container.innerHTML = '';
        const list = recipes.filter(r => favorites.includes(r.id));
        document.getElementById('emptyFavMessage').style.display = list.length ? 'none' : 'block';
        list.forEach(r => container.appendChild(createRecipeCard(r)));
    }


    function createRecipeCard(r) {
        const div = document.createElement('div');
        div.className = 'recipe-item';
        div.draggable = true; 
        div.dataset.recipeId = r.id; 
        
        div.innerHTML = `
            <img src="${r.imageData || 'https://via.placeholder.com/300x180?text=Food'}" loading="lazy">
            <div class="card-actions">
                <button class="card-btn fav ${favorites.includes(r.id)?'active':''}" data-id="${r.id}">‚ô•</button>
                <button class="card-btn delete" data-id="${r.id}">üóë</button>
            </div>
            <h3>${r.title}</h3>
        `;
        div.querySelector('.fav').onclick = (e) => { e.stopPropagation(); toggleFavorite(r.id); };
        div.querySelector('.delete').onclick = (e) => { e.stopPropagation(); deleteRecipe(r.id); }; // RESTORED DELETE
        div.onclick = () => openDetail(r);
        div.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', r.id);
            e.dataTransfer.setData('source-type', 'list'); // Indicate drag is from recipe list (copy)
            console.log(`Dragstart from list: Recipe ID ${r.id}, Source Type 'list'`);
        });
        return div;
    }

    // --- JSON-LD IMPORT LOGIC (Client-side) ---
    document.getElementById('btnImportJson').onclick = () => {
        const jsonText = document.getElementById('inpImportJson').value;
        if(!jsonText) {
            alert("Please paste the JSON-LD data into the text area.");
            return;
        }
        
        try {
            let recipeData = JSON.parse(jsonText);

            const findRecipe = (obj) => {
                if (obj && (obj['@type'] === 'Recipe' || (Array.isArray(obj['@type']) && obj['@type'].includes('Recipe')))) return obj;
                return null;
            };

            let foundRecipe = null;
            if (Array.isArray(recipeData)) {
                foundRecipe = recipeData.find(findRecipe);
            } else if (recipeData['@graph']) { 
                foundRecipe = recipeData['@graph'].find(findRecipe);
            } else {
                foundRecipe = findRecipe(recipeData);
            }

            if (!foundRecipe) {
                alert("Could not find a valid 'Recipe' object in the provided JSON-LD.");
                return;
            }
            
            document.getElementById('inpTitle').value = foundRecipe.name || "";
            document.getElementById('inpSource').value = foundRecipe.url || "";
            document.getElementById('inpServings').value = parseInt(foundRecipe.recipeYield) || 4;

            // Tags: attempt to extract keywords as tags
            let importedTags = [];
            if (foundRecipe.keywords) {
                importedTags = Array.isArray(foundRecipe.keywords) ? foundRecipe.keywords : foundRecipe.keywords.split(',').map(t => t.trim());
            } else if (foundRecipe.recipeCategory) {
                importedTags = Array.isArray(foundRecipe.recipeCategory) ? foundRecipe.recipeCategory : [foundRecipe.recipeCategory];
            }
            document.getElementById('inpTags').value = importedTags.join(', ');


            if (foundRecipe.recipeIngredient) {
                document.getElementById('inpIngredients').value = Array.isArray(foundRecipe.recipeIngredient) 
                    ? foundRecipe.recipeIngredient.join('\n') 
                    : foundRecipe.recipeIngredient;
            }

            if (foundRecipe.recipeInstructions) {
                let instructions = [];
                if (Array.isArray(foundRecipe.recipeInstructions)) {
                    instructions = foundRecipe.recipeInstructions.map(step => step.text || step.name || step).filter(Boolean);
                } else {
                    instructions = [foundRecipe.recipeInstructions];
                }
                document.getElementById('inpInstructions').value = instructions.join('\n');
            }

            if (foundRecipe.nutrition) {
                document.getElementById('inpCal').value = parseInt(foundRecipe.nutrition.calories) || "";
                document.getElementById('inpPro').value = parseInt(foundRecipe.nutrition.proteinContent) || "";
                document.getElementById('inpCarb').value = parseInt(foundRecipe.nutrition.carbohydrateContent) || "";
                document.getElementById('inpFat').value = parseInt(foundRecipe.nutrition.fatContent) || "";
            } else { 
                document.getElementById('inpCal').value = "";
                document.getElementById('inpPro').value = "";
                document.getElementById('inpCarb').value = "";
                document.getElementById('inpFat').value = "";
            }

            alert("Recipe data parsed! Please review and select tags before saving.");
            document.getElementById('inpImportJson').value = ''; // Clear the textarea
        } catch (error) {
            alert("Error parsing JSON: " + error.message + "\nPlease ensure you've pasted valid JSON-LD.");
            console.error("JSON-LD parse error:", error);
        }
    };

    // --- MEAL PLAN & SHOPPING ---
    function renderMealPlanGrid() {
        console.log("Rendering meal plan grid...");
        const grid = document.getElementById('mealPlanGrid');
        grid.innerHTML = '';
        const week = document.getElementById('mealPlanWeekSelect').value;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        days.forEach(day => {
            const dayKey = `${week}-${day.toLowerCase()}`;
            const col = document.createElement('div');
            col.className = 'meal-day-column';
            col.dataset.dayKey = dayKey; 
            
            col.innerHTML = `
                <div class="day-header">
                    ${day}
                    <button class="add-meal-day-btn" data-key="${dayKey}">+</button>
                </div>
                <div class="day-content"></div>
            `;

            col.querySelector('.add-meal-day-btn').onclick = (e) => {
                e.stopPropagation(); 
                openSelectModal(dayKey, day);
            };

            const content = col.querySelector('.day-content');
            
            content.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                const afterElement = getDragAfterElement(content, e.clientY);
                const dragging = document.querySelector('.meal-card.dragging');
                if (dragging && afterElement) {
                    content.insertBefore(dragging, afterElement);
                } else if (dragging) {
                    content.appendChild(dragging);
                }
                col.classList.add('drag-over'); 
            });
            content.addEventListener('dragleave', () => col.classList.remove('drag-over'));
            
            content.addEventListener('drop', async (e) => {
                e.preventDefault();
                col.classList.remove('drag-over');
                const recipeId = e.dataTransfer.getData('text/plain');
                const sourceType = e.dataTransfer.getData('source-type'); 
                const sourceDayKey = e.dataTransfer.getData('source-day'); 
                
                console.log(`Drop event: Recipe ID ${recipeId}, Source Type '${sourceType}', Source Day '${sourceDayKey}', Target Day '${dayKey}'`);

                if (!recipeId) {
                    console.log("No recipe ID in dataTransfer, ignoring drop.");
                    return;
                }

                if (!mealPlan[dayKey]) mealPlan[dayKey] = [];

                // Handle MOVE operation (from one meal plan day to another)
                if (sourceType === 'plan' && sourceDayKey && sourceDayKey !== dayKey) {
                    console.log(`Performing MOVE: Removing from ${sourceDayKey}, adding to ${dayKey}`);
                    mealPlan[sourceDayKey] = mealPlan[sourceDayKey].filter(id => id !== recipeId);
                    if (mealPlan[sourceDayKey].length === 0) delete mealPlan[sourceDayKey]; 
                    
                    if (!mealPlan[dayKey].includes(recipeId)) {
                        const newOrder = Array.from(content.children).map(el => el.dataset.recipeId);
                        // Make sure recipeId is actually in newOrder if it's not a duplicate copy
                        if (!newOrder.includes(recipeId)) {
                            mealPlan[dayKey] = newOrder.concat(recipeId);
                        } else {
                            mealPlan[dayKey] = newOrder; // Just update order
                        }
                    } else {
                        console.log(`Recipe ${recipeId} already exists in target day ${dayKey}. Reordering only.`);
                        const newOrder = Array.from(content.children).map(el => el.dataset.recipeId);
                        mealPlan[dayKey] = newOrder;
                    }
                } 
                // Handle COPY operation (from the main recipe list)
                else if (sourceType === 'list') {
                    console.log(`Performing COPY: Adding to ${dayKey} from main list.`);
                    if (mealPlan[dayKey].includes(recipeId)) {
                        alert("Recipe already on this day's plan.");
                    } else {
                        const newOrder = Array.from(content.children).map(el => el.dataset.recipeId);
                        mealPlan[dayKey] = newOrder.filter(id => id !== recipeId).concat(recipeId); // Add at the end or at drop position
                    }
                } 
                // Handle reordering within the same day
                else if (sourceType === 'plan' && sourceDayKey === dayKey) {
                    console.log(`Performing REORDER within ${dayKey}`);
                    const newOrder = Array.from(content.children).map(el => el.dataset.recipeId);
                    mealPlan[dayKey] = newOrder;
                } else {
                    console.log("Drop event occurred, but no specific action taken based on source type or day.");
                }
                
                document.querySelectorAll('.meal-card.dragging').forEach(el => el.classList.remove('dragging'));

                await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
                renderMealPlanGrid(); 
            });

            (mealPlan[dayKey] || []).forEach(id => {
                const r = recipes.find(x => x.id === id);
                if(r) content.appendChild(createMealCardElement(r, dayKey));
            });
            grid.appendChild(col);
        });
    }

    function createMealCardElement(r, dayKey) {
        const card = document.createElement('div');
        card.className = 'meal-card';
        card.draggable = true;
        card.dataset.recipeId = r.id; // Store recipe ID
        
        card.innerHTML = `<img src="${r.imageData || 'https://via.placeholder.com/150x90?text=Food'}" loading="lazy"><div class="meal-card-title">${r.title}</div><button class="remove-meal-btn">‚úï</button>`;
        
        card.querySelector('.remove-meal-btn').onclick = async (e) => {
            e.stopPropagation();
            console.log(`Removing recipe ${r.id} from day ${dayKey}`);
            mealPlan[dayKey] = mealPlan[dayKey].filter(x => x !== r.id);
            if (mealPlan[dayKey].length === 0) delete mealPlan[dayKey]; 
            await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
            renderMealPlanGrid();
        };
        
        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', r.id);
            e.dataTransfer.setData('source-type', 'plan'); // Indicate drag is from meal plan (move potential)
            e.dataTransfer.setData('source-day', dayKey); // Store source day key
            e.target.classList.add('dragging'); // Add class to the dragged item
            console.log(`Dragstart from meal plan: Recipe ID ${r.id}, Source Type 'plan', Source Day '${dayKey}'`);
        });

        card.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging'); // Remove class when drag ends
        });
        
        card.onclick = () => openDetail(r);
        return card;
    }

    // Helper for finding position during dragover (meal plan reordering)
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.meal-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: -Infinity }).element;
    }

    // Manual Add Modal for Meal Plan Days
    let targetDayKeyForAdd = null;
    function openSelectModal(dayKey, dayName) {
        targetDayKeyForAdd = dayKey;
        document.getElementById('targetDayName').textContent = dayName;
        const sel = document.getElementById('mealPlanSelectDropdown');
        sel.innerHTML = '<option value="">Select a Recipe...</option>';
        [...recipes].sort((a,b) => a.title.localeCompare(b.title)).forEach(r => {
            sel.add(new Option(r.title, r.id));
        });
        document.getElementById('selectRecipeModal').classList.add('active');
    }

    document.getElementById('confirmSelectBtn').onclick = async () => {
        const rid = document.getElementById('mealPlanSelectDropdown').value;
        if(rid && targetDayKeyForAdd) {
            if(!mealPlan[targetDayKeyForAdd]) mealPlan[targetDayKeyForAdd] = [];
            if(mealPlan[targetDayKeyForAdd].includes(rid)) {
                alert("Recipe already on this day's plan.");
            } else {
                mealPlan[targetDayKeyForAdd].push(rid);
                await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
                renderMealPlanGrid();
            }
            document.getElementById('selectRecipeModal').classList.remove('active');
        } else {
            alert("Please select a recipe.");
        }
    };
    document.getElementById('cancelSelectBtn').onclick = () => document.getElementById('selectRecipeModal').classList.remove('active');


    // --- SMART SHOPPING & FRACTIONS ---

    const quantityRegex = /^(\d+(?:\.\d+)?|\d+\s*\d*\/\d+|\d+\/\d+)/; // Matches "1", "0.5", "1 1/2", "1/2"
    
    // Comprehensive list of unit variations and their normalized singular forms
    const unitMap = {
        'cup': 'cup', 'cups': 'cup', 'c': 'cup', 'c.': 'cup',
        'teaspoon': 'teaspoon', 'teaspoons': 'teaspoon', 'tsp': 'teaspoon', 'tsps': 'teaspoon', 't': 'teaspoon',
        'tablespoon': 'tablespoon', 'tablespoons': 'tablespoon', 'tbsp': 'tablespoon', 'tbsps': 'tablespoon', 'T': 'tablespoon',
        'gram': 'gram', 'grams': 'gram', 'g': 'gram', 'g.': 'gram',
        'kilogram': 'kilogram', 'kilograms': 'kilogram', 'kg': 'kilogram', 'kg.': 'kilogram',
        'milliliter': 'milliliter', 'milliliters': 'milliliter', 'ml': 'milliliter', 'ml.': 'milliliter',
        'liter': 'liter', 'liters': 'liter', 'l': 'liter', 'l.': 'liter',
        'ounce': 'ounce', 'ounces': 'ounce', 'oz': 'ounce', 'oz.': 'ounce', 'fl oz': 'fluid ounce', 'fluid ounce': 'fluid ounce',
        'pound': 'pound', 'pounds': 'pound', 'lb': 'pound', 'lbs': 'pound', 'lb.': 'pound', 'lbs.': 'pound',
        'pinch': 'pinch', 'pinches': 'pinch', 'dash': 'dash', 'dashes': 'dash',
        'clove': 'clove', 'cloves': 'clove', 'stalk': 'stalk', 'stalks': 'stalk',
        'sprig': 'sprig', 'sprigs': 'sprig', 'can': 'can', 'cans': 'can',
        'package': 'package', 'packages': 'package', 'box': 'box', 'boxes': 'box',
        'slice': 'slice', 'slices': 'slice', 'head': 'head', 'heads': 'head',
        'leaf': 'leaf', 'leaves': 'leaf', 'container': 'container', 'containers': 'container',
        'each': 'each', 'ea': 'each', 'piece': 'piece', 'pieces': 'piece',
        'bottle': 'bottle', 'bottles': 'bottle', 'jar': 'jar', 'jars': 'jar',
        'carton': 'carton', 'cartons': 'carton', 'bunch': 'bunch', 'bunches': 'bunch',
        'bag': 'bag', 'bags': 'bag', 'drop': 'drop', 'drops': 'drop'
    };

    const commonDescriptors = [
        'melted', 'softened', 'diced', 'chopped', 'sliced', 'minced', 'grated', 'shredded', 'crushed',
        'fresh', 'frozen', 'dried', 'ground', 'whole', 'cut', 'cubed', 'quartered', 'halved',
        'peeled', 'unpeeled', 'seeded', 'cored', 'rinsed', 'drained', 'patted dry', 'wiped',
        'unsalted', 'salted', 'low-sodium', 'reduced-sodium', 'full-fat', 'low-fat', 'fat-free',
        'sweet', 'sour', 'bitter', 'spicy', 'hot', 'mild', 'extra', 'fine', 'coarse',
        'cold', 'warm', 'hot', 'room temperature', 'chilled', 'lukewarm',
        'packed', 'heaping', 'lightly packed', 'loose', 'a', 'an', 'the', 'some',
        'good quality', 'best quality', 'superfine', 'blanched',
        'a pinch of', 'a dash of', 'a sprinkle of', 'a couple of', 'toasted', 'roasted', 'cooked', 'raw',
        'organic', 'farm-fresh', 'aged', 'filtered', 'divided', 'such as',
        'or more', 'or less', 'about', 'approximately', 'small', 'medium', 'large', 'jumbo', 'extra large', 'tiny', 'baby',
        'for serving', 'for garnish', 'as needed', 'to taste', 'optional', 'plus more for dusting', 'plus more for serving', 'for pan', 'for coating'
    ];

    // Default aisle mapping (you can expand this list!)
    const defaultAisleMap = {
        'flour': 'Baking', 'sugar': 'Baking', 'baking powder': 'Baking', 'baking soda': 'Baking', 'vanilla extract': 'Baking',
        'butter': 'Dairy', 'milk': 'Dairy', 'cheese': 'Dairy', 'yogurt': 'Dairy', 'eggs': 'Dairy', 'cream': 'Dairy',
        'chicken': 'Meat & Seafood', 'beef': 'Meat & Seafood', 'pork': 'Meat & Seafood', 'fish': 'Meat & Seafood', 'shrimp': 'Meat & Seafood',
        'onion': 'Produce', 'garlic': 'Produce', 'potato': 'Produce', 'carrot': 'Produce', 'lettuce': 'Produce', 'tomato': 'Produce', 'apple': 'Produce', 'banana': 'Produce', 'berry': 'Produce', 'lemon': 'Produce', 'lime': 'Produce',
        'salt': 'Spices & Seasonings', 'pepper': 'Spices & Seasonings', 'oregano': 'Spices & Seasonings', 'cumin': 'Spices & Seasonings', 'basil': 'Spices & Seasonings', 'thyme': 'Spices & Seasonings', 'paprika': 'Spices & Seasonings',
        'pasta': 'Pantry', 'rice': 'Pantry', 'canola oil': 'Pantry', 'olive oil': 'Pantry', 'vinegar': 'Pantry', 'broth': 'Pantry', 'canned tomato': 'Pantry', 'beans': 'Pantry', 'cereal': 'Pantry', 'coffee': 'Pantry', 'tea': 'Pantry',
        'bread': 'Bakery', 'rolls': 'Bakery', 'baguette': 'Bakery'
    };

    function getAisleSuggestion(ingredientName) {
        // First, check if the ingredient has an explicit aisle defined by the user
        const aisleMatch = ingredientName.match(/(\s*\/\/\s*)([^/]+)$/);
        if (aisleMatch && aisleMatch[2]) {
            // Capitalize first letter of each word in the aisle name
            return aisleMatch[2].trim().replace(/\s{2,}/g, ' ').replace(/(^|\s)\S/g, l => l.toUpperCase()); 
        }

        // If not, use the default map
        for (const [key, aisle] of Object.entries(defaultAisleMap)) {
            // Check if the ingredient name contains the key
            if (ingredientName.includes(key)) {
                return aisle;
            }
        }
        return 'Other'; // Fallback
    }

    function normalizeIngredientName(ingredientString) {
        let original = ingredientString.toLowerCase().trim();
        let quantity = 0;
        let unit = '';
        let aisle = getAisleSuggestion(original); 

        // Strip user-defined aisle hint before parsing quantities/units
        let remaining = original;
        const aisleHintRemovedMatch = remaining.match(/^(.*?)(?:\s*\/\/\s*[^/]+)$/);
        if (aisleHintRemovedMatch) {
            remaining = aisleHintRemovedMatch[1].trim();
        }

        // 1. Try to extract Quantity
        const qtyMatch = remaining.match(quantityRegex);
        if (qtyMatch) {
            let qtyStr = qtyMatch[1].trim();
            remaining = remaining.substring(qtyMatch[0].length).trim();

            if (qtyStr.includes('/')) { 
                const parts = qtyStr.split(' ').map(p => {
                    if (p.includes('/')) {
                        const [n, d] = p.split('/');
                        return parseFloat(n) / parseFloat(d);
                    }
                    return parseFloat(p);
                });
                quantity = parts.reduce((sum, current) => sum + current, 0);
            } else {
                quantity = parseFloat(qtyStr);
            }
        } else {
            quantity = 1; 
        }

        // 2. Try to extract Unit
        const sortedUnits = Object.keys(unitMap).sort((a, b) => b.length - a.length);
        
        for (const u of sortedUnits) {
            const unitMatchRegex = new RegExp(`^(${u})(?:s|\\.)?(?:\\s+of\\b|\\b)?`, 'i');
            const matchInRemaining = remaining.match(unitMatchRegex);

            if (matchInRemaining) {
                unit = unitMap[u]; // Use normalized unit
                remaining = remaining.substring(matchInRemaining[0].length).trim();
                break; 
            }
        }

        let name = remaining;

        // 3. Strip common descriptors from the name
        let cleanedName = name;
        commonDescriptors.forEach(desc => {
            const descPattern = new RegExp(`(?:^|,|\\s)\\b${desc}\\b(?:$|,|\\s)`, 'gi');
            cleanedName = cleanedName.replace(descPattern, ' ').trim();
        });

        cleanedName = cleanedName.replace(/^[,\s.]+/, '').replace(/[,\s.]+$/, '').replace(/\s{2,}/g, ' ').trim();
        
        const exceptions = ['molasses', 'asparagus', 'oats', 'chips', 'nuts', 'beans', 'peas', 'greens', 'glass'];
        if (cleanedName.length > 3 && cleanedName.endsWith('s') && !exceptions.includes(cleanedName)) {
             cleanedName = cleanedName.slice(0, -1);
        }

        if (!cleanedName) {
            cleanedName = name; 
        }
        if (!cleanedName) {
            cleanedName = original; 
        }
        
        cleanedName = cleanedName.replace(/^[^a-z0-9]*/i, '').trim();
        
        return {
            quantity: quantity,
            unit: unit,
            name: cleanedName,
            aisle: aisle
        };
    }

    // Helper for displaying fractions nicely
    function formatFraction(d) {
        if (typeof d !== 'number' || isNaN(d) || d === 0) return "0";
        const tolerance = 0.005; 
        const whole = Math.floor(d);
        const rem = d - whole;

        if (Math.abs(rem) < tolerance) return Math.round(d).toString();

        const fracs = {
            0.125: "‚Öõ", 0.166: "‚Öô", 0.2: "‚Öï", 0.25: "¬º", 0.333: "‚Öì", 0.375: "‚Öú",
            0.4: "‚Öñ", 0.5: "¬Ω", 0.6: "‚Öó", 0.625: "‚Öù", 0.666: "‚Öî", 0.75: "¬æ",
            0.8: "‚Öò", 0.833: "‚Öö", 0.875: "‚Öû"
        };
        
        let closestFractionSymbol = "";
        let minDiff = 1; 

        for (let key in fracs) {
            const val = parseFloat(key);
            if (Math.abs(val - rem) < minDiff) {
                minDiff = Math.abs(val - rem);
                closestFractionSymbol = fracs[key];
            }
        }

        if (closestFractionSymbol && minDiff < tolerance * 2) { 
            return whole > 0 ? `${whole} ${closestFractionSymbol}` : closestFractionSymbol;
        }
        return d.toFixed(2).replace(/\.?0+$/, ''); 
    }

    function renderShoppingList() {
        console.log("Rendering shopping list...");
        const div = document.getElementById('shoppingListContainer');
        div.innerHTML = '';
        const week = document.getElementById('mealPlanWeekSelect').value;
        const allIngredientsRaw = [];
        
        Object.keys(mealPlan).filter(k => k.startsWith(week)).forEach(k => {
            mealPlan[k].forEach(rid => {
                const r = recipes.find(x => x.id === rid);
                if(r && r.ingredients) allIngredientsRaw.push(...r.ingredients);
            });
        });

        if (allIngredientsRaw.length === 0) {
            div.innerHTML = '<p style="text-align:center; padding:20px;">No recipes in the meal plan for this week.</p>';
            return;
        }

        const aggregatedIngredients = {};

        allIngredientsRaw.forEach(line => {
            const parsed = normalizeIngredientName(line);

            // Create a consistent aggregation key: "name (unit)"
            let aggKey = parsed.name;
            if (parsed.unit) {
                aggKey += ` (${parsed.unit})`;
            }

            if (!aggregatedIngredients[aggKey]) {
                aggregatedIngredients[aggKey] = { quantity: 0, unit: parsed.unit, name: parsed.name, aisle: parsed.aisle };
            }
            aggregatedIngredients[aggKey].quantity += parsed.quantity;
        });

        // Group by aisle
        const itemsByAisle = {};
        Object.values(aggregatedIngredients).forEach(item => {
            const aisleName = item.aisle || 'Other';
            if (!itemsByAisle[aisleName]) {
                itemsByAisle[aisleName] = [];
            }
            itemsByAisle[aisleName].push(item);
        });

        // Sort aisles for display
        const customAisleOrder = [
            'Produce', 'Bakery', 'Meat & Seafood', 'Dairy', 'Frozen', 'Pantry', 'Baking', 
            'Spices & Seasonings', 'Beverages', 'Canned Goods', 'Other'
        ];
        const sortedAisles = Object.keys(itemsByAisle).sort((a, b) => {
            const indexA = customAisleOrder.indexOf(a);
            const indexB = customAisleOrder.indexOf(b);
            if (indexA === -1 && indexB === -1) return a.localeCompare(b);
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });


        // Render grouped and sorted list
        sortedAisles.forEach(aisle => {
            const aisleGroupDiv = document.createElement('div');
            aisleGroupDiv.className = 'aisle-group';
            aisleGroupDiv.innerHTML = `<div class="aisle-header">${aisle}</div><div class="aisle-items"></div>`;
            const aisleItemsContainer = aisleGroupDiv.querySelector('.aisle-items');

            itemsByAisle[aisle].sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                const d = document.createElement('div');
                d.className = 'shopping-item';
                
                let displayQuantity = formatFraction(item.quantity);
                let displayText;

                if (item.unit && item.name) {
                    displayText = `${displayQuantity} ${item.unit} ${item.name}`;
                } else if (item.name && item.quantity > 0 && !isNaN(item.quantity)) { 
                    if (item.quantity === 1 && !item.unit && item.name.split(' ').length === 1) {
                         displayText = item.name;
                    } else {
                         displayText = `${displayQuantity} ${item.name}`;
                    }
                } else {
                    displayText = item.name || "Unknown Item"; 
                }
                
                d.innerHTML = `<input type="checkbox"><span>${displayText}</span>`;
                d.querySelector('input').onclick = (e) => e.target.checked ? d.classList.add('checked') : d.classList.remove('checked');
                aisleItemsContainer.appendChild(d);
            });
            div.appendChild(aisleGroupDiv);
        });
        console.log("Shopping list rendered.");
    }


    // --- GENERIC ACTIONS ---
    async function toggleFavorite(id) {
        favorites.includes(id) ? favorites=favorites.filter(x=>x!==id) : favorites.push(id);
        await setDoc(doc(db,'appData','favorites'), {ids:favorites});
        if(document.getElementById('viewFavoritesBtn').classList.contains('active')) renderFavoritesList();
        else renderRecipeList();
    }

    async function deleteRecipe(id) {
        if(!confirm("Permanently delete this recipe?")) return;
        const recipeToDelete = recipes.find(r => r.id === id);
        try {
            if (recipeToDelete && recipeToDelete.imageData && recipeToDelete.imageData.startsWith('https://firebasestorage.googleapis.com/')) {
                try { await deleteObject(ref(storage, recipeToDelete.imageData)); } catch (err) { console.warn("Image deletion failed:", err); }
            }
            await deleteDoc(doc(db, 'recipes', id));
            
            favorites = favorites.filter(x => x !== id); await setDoc(doc(db,'appData','favorites'), {ids:favorites});
            
            let mealPlanChanged = false;
            Object.keys(mealPlan).forEach(k => {
                if(mealPlan[k].includes(id)) {
                    mealPlan[k] = mealPlan[k].filter(x => x !== id);
                    if(mealPlan[k].length === 0) delete mealPlan[k];
                    mealPlanChanged = true;
                }
            });
            if(mealPlanChanged) await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });

            await loadRecipes(); 
            const activeViewBtn = document.querySelector('.view-toggle button.active');
            if (activeViewBtn) {
                const viewName = activeViewBtn.id.replace('view','').toLowerCase().replace('btn','');
                showView(viewName);
            } else {
                showView('recipes'); 
            }
            // Close the detail modal if recipe was deleted from there
            if (document.getElementById('detailModal').classList.contains('active')) {
                document.getElementById('detailModal').classList.remove('active');
            }
        } catch (e) { alert("Error deleting recipe."); console.error(e); }
    }

    async function saveRecipe(data) {
        const btn = document.getElementById('btnSave'); btn.textContent="Saving..."; btn.disabled=true;
        try {
            if(currentImageFile) {
                const snap = await uploadString(ref(storage, `img_${Date.now()}`), currentImageFile, 'data_url');
                data.imageData = await getDownloadURL(snap.ref);
            } else if (data.id) { 
                const old = recipes.find(r=>r.id===data.id);
                if(old) data.imageData = old.imageData;
            }
            
            // Add new tags to the global list if they don't exist
            data.tags.forEach(tag => {
                if (!allTags.includes(tag)) {
                    allTags.push(tag);
                }
            });
            allTags.sort(); // Keep tags sorted

            if(data.id) await updateDoc(doc(db,'recipes',data.id), data);
            else await addDoc(collection(db,'recipes'), data);
            
            await saveGlobalTags(); // Save updated global tags list
            await loadRecipes();
            showView('recipes');
            document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'));
        } catch(e) { alert("Save Error"); console.error(e); }
        btn.textContent="Save Recipe"; btn.disabled=false;
    }

    // --- MODALS AND DETAILS ---
    function openDetail(r) {
        activeRecipeId = r.id; 
        document.getElementById('detTitle').textContent = r.title;
        
        // Tags display
        const detTagsDiv = document.getElementById('detTags');
        detTagsDiv.innerHTML = '';
        if (r.tags && r.tags.length > 0) {
            r.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'detail-tag';
                span.textContent = tag;
                detTagsDiv.appendChild(span);
            });
        } else {
            const span = document.createElement('span');
            span.className = 'detail-tag';
            span.textContent = 'Untagged';
            detTagsDiv.appendChild(span);
        }

        document.getElementById('detOrigServings').textContent = r.originalServings;
        document.getElementById('detDesiredServings').value = r.originalServings;
        document.getElementById('detNotes').value = r.notes || '';
        
        const nGrid = document.getElementById('detNutrition');
        if(r.nutrition && (r.nutrition.cal || r.nutrition.pro || r.nutrition.carb || r.nutrition.fat)) {
            nGrid.style.display='grid';
            document.getElementById('valCal').textContent = r.nutrition.cal || 0;
            document.getElementById('valPro').textContent = (r.nutrition.pro || 0)+'g';
            document.getElementById('valCarb').textContent = (r.nutrition.carb || 0)+'g';
            document.getElementById('valFat').textContent = (r.nutrition.fat || 0)+'g';
        } else nGrid.style.display='none';

        const srcLink = document.getElementById('detSourceLink');
        if(r.source && r.source.trim() !== '') {
            srcLink.href = r.source; srcLink.style.display = 'block';
        } else srcLink.style.display = 'none';

        updateStars(document.getElementById('detRating'), r.rating || 0);
        renderIngredientsInDetail(r, 1);

        const div = document.getElementById('detInstructions'); div.innerHTML='';
        r.instructions.forEach((s,i) => {
            const d = document.createElement('div'); d.className='instruction-step';
            d.innerHTML = `<strong>Step ${i+1}</strong> ${s}`;
            div.appendChild(d);
        });

        document.getElementById('detailModal').classList.add('active');
        // Set the recipe ID for the detail delete button
        document.getElementById('btnDeleteRecipeDetail').dataset.recipeId = r.id; 
    }

    function renderIngredientsInDetail(r, scale) {
        const list = document.getElementById('detIngredients');
        list.innerHTML = '';
        
        r.ingredients.forEach(ing => {
            const li = document.createElement('li');
            li.onclick = () => li.classList.toggle('checked');
            
            const parsed = normalizeIngredientName(ing);
            let displayText;

            let scaledQuantity = parsed.quantity * scale;

            if (parsed.unit && parsed.name) {
                displayText = `${formatFraction(scaledQuantity)} ${parsed.unit} ${parsed.name}`;
            } else if (parsed.name && parsed.quantity > 0 && !isNaN(scaledQuantity)) {
                if (scaledQuantity === 1 && !parsed.unit && parsed.name.split(' ').length === 1) {
                     displayText = parsed.name;
                } else {
                     displayText = `${formatFraction(scaledQuantity)} ${parsed.name}`;
                }
            } else {
                displayText = ing; 
            }
            li.textContent = displayText;
            list.appendChild(li);
        });
    }

    function updateStars(el, val) {
        Array.from(el.children).forEach(s => s.classList.toggle('filled', parseInt(s.getAttribute('data-v')) <= val));
    }

    // --- UNIT CONVERSION LOGIC ---

    const CONVERSION_FACTORS = {
        // All units convert to a base unit (ml for volume, g for weight)
        volume: {
            'tsp': 4.92892,
            'tbsp': 14.7868,
            'cup': 236.588,
            'floz': 29.5735,
            'ml': 1,
            'l': 1000
        },
        weight: {
            'g': 1,
            'oz_w': 28.3495, // oz (weight)
            'lb': 453.592,
            'kg': 1000
        }
    };

    function populateUnitSelects() {
        const inputSelect = document.getElementById('convertInputUnit');
        const outputSelect = document.getElementById('convertOutputUnit');
        inputSelect.innerHTML = '';
        outputSelect.innerHTML = '';

        const allUnits = [...Object.keys(CONVERSION_FACTORS.volume), ...Object.keys(CONVERSION_FACTORS.weight)];
        allUnits.forEach(unit => {
            const option1 = document.createElement('option');
            option1.value = unit;
            option1.textContent = unit;
            inputSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = unit;
            option2.textContent = unit;
            outputSelect.appendChild(option2);
        });

        // Set default selections
        inputSelect.value = 'tbsp';
        outputSelect.value = 'cup';
    }

    function getUnitType(unit) {
        if (CONVERSION_FACTORS.volume[unit]) return 'volume';
        if (CONVERSION_FACTORS.weight[unit]) return 'weight';
        return null;
    }

    function convertUnits() {
        const qty = parseFloat(document.getElementById('convertInputQty').value);
        const fromUnit = document.getElementById('convertInputUnit').value;
        const toUnit = document.getElementById('convertOutputUnit').value;
        const outputSpan = document.getElementById('convertOutputQty');

        if (isNaN(qty) || qty <= 0) {
            outputSpan.textContent = "Invalid Qty";
            return;
        }

        const fromType = getUnitType(fromUnit);
        const toType = getUnitType(toUnit);

        if (!fromType || !toType) {
            outputSpan.textContent = "Unknown Unit";
            return;
        }

        if (fromType !== toType) {
            outputSpan.textContent = "Can't convert volume to weight directly.";
            return;
        }

        const baseUnitValue = qty * CONVERSION_FACTORS[fromType][fromUnit];
        const convertedValue = baseUnitValue / CONVERSION_FACTORS[toType][toUnit];

        outputSpan.textContent = convertedValue.toFixed(2);
    }

    // --- EVENT LISTENERS ---
    
    // Timer functions (unchanged)
    document.getElementById('customTimerBtn').onclick = () => {
        const minStr = prompt("Enter minutes for timer:", "5");
        if(minStr && !isNaN(parseFloat(minStr))) runTimer(parseFloat(minStr), "Custom");
    };
    document.getElementById('cancelTimerBtn').onclick = () => {
        if(currentTimer) clearInterval(currentTimer);
        document.getElementById('timerIndicator').style.display = 'none';
        currentTimer = null;
    };
    function runTimer(min, txt) { 
        stopTimer(); 
        const el = document.getElementById('timerIndicator');
        const txtEl = document.getElementById('timerText');
        el.style.display = 'flex';
        
        let sec = min * 60;
        
        currentTimer = setInterval(() => {
            sec--;
            if (sec < 0) {
                stopTimer();
                alert(`Timer Finished: ${txt}`);
                return;
            }
            const m = Math.floor(sec/60);
            const s = sec%60;
            txtEl.textContent = `${txt ? txt+': ' : ''}${m}:${s.toString().padStart(2,'0')}`;
            if(sec === 0) {
                stopTimer();
                alert(`Timer Finished: ${txt}`);
            }
        }, 1000);
    }
    function stopTimer() {
        if(currentTimer) clearInterval(currentTimer);
        document.getElementById('timerIndicator').style.display = 'none';
        currentTimer = null;
    }

    // View Switching
    ['recipes','mealPlan','shopping','favorites'].forEach(v => {
        document.getElementById(`view${v.charAt(0).toUpperCase()+v.slice(1)}Btn`).onclick = () => showView(v);
    });
    function showView(v) {
        console.log(`Showing view: ${v}`);
        document.querySelectorAll('.view-toggle button').forEach(b=>b.classList.remove('active'));
        document.getElementById(`view${v.charAt(0).toUpperCase()+v.slice(1)}Btn`).classList.add('active');
        ['recipes','mealPlan','shopping','favorites'].forEach(x=>document.getElementById(`${x}View`).style.display='none');
        document.getElementById(`${v}View`).style.display='block';
        
        document.getElementById('recipeControls').style.display = v==='recipes'?'flex':'none';

        if(v==='recipes') renderRecipeList();
        else if(v==='mealPlan') renderMealPlanGrid();
        else if(v==='shopping') renderShoppingList();
        else if(v==='favorites') renderFavoritesList();
    }

    // Modal Triggers
    document.getElementById('openAddModalBtn').onclick = () => {
        document.getElementById('recipeForm').reset();
        document.getElementById('editId').value = "";
        document.getElementById('inpSource').value = "";
        document.getElementById('inpImportJson').value = ""; // Clear import textarea
        document.getElementById('inpTags').value = ""; // Clear tags input
        currentImageFile = null; 
        updateStars(document.getElementById('inpRating'), 0);
        document.getElementById('modalTitle').textContent = "Add New Recipe";
        document.getElementById('recipeModal').classList.add('active');
    };
    document.querySelectorAll('.close-modal').forEach(b=>b.onclick=()=>document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active')));

    // Edit Button in Detail View
    document.getElementById('btnEditRecipe').onclick = () => {
        const r = recipes.find(x=>x.id===activeRecipeId);
        if(!r) return;
        document.getElementById('detailModal').classList.remove('active');
        
        document.getElementById('editId').value = r.id;
        document.getElementById('inpTitle').value = r.title;
        document.getElementById('inpSource').value = r.source || "";
        document.getElementById('inpTags').value = r.tags ? r.tags.join(', ') : ""; // Set tags
        document.getElementById('inpServings').value = r.originalServings;
        document.getElementById('inpIngredients').value = r.ingredients.join('\n');
        document.getElementById('inpInstructions').value = r.instructions.join('\n');
        
        if(r.nutrition) {
            document.getElementById('inpCal').value = r.nutrition.cal || "";
            document.getElementById('inpPro').value = r.nutrition.pro || "";
            document.getElementById('inpCarb').value = r.nutrition.carb || "";
            document.getElementById('inpFat').value = r.nutrition.fat || "";
        } else {
            document.getElementById('inpCal').value = ""; document.getElementById('inpPro').value = "";
            document.getElementById('inpCarb').value = ""; document.getElementById('inpFat').value = "";
        }

        updateStars(document.getElementById('inpRating'), r.rating);
        document.getElementById('inpRating').dataset.val = r.rating;
        currentImageFile = null; 
        
        document.getElementById('recipeModal').classList.add('active');
    };

    // Form Submit
    document.getElementById('recipeForm').onsubmit = (e) => {
        e.preventDefault();
        const d = {
            title: document.getElementById('inpTitle').value,
            source: document.getElementById('inpSource').value,
            tags: document.getElementById('inpTags').value.split(',').map(tag => tag.trim()).filter(tag => tag), // Parse tags
            originalServings: document.getElementById('inpServings').value,
            ingredients: document.getElementById('inpIngredients').value.split('\n').filter(x=>x.trim()),
            instructions: document.getElementById('inpInstructions').value.split('\n').filter(x=>x.trim()),
            rating: parseInt(document.getElementById('inpRating').dataset.val || 0),
            nutrition: {
                cal: document.getElementById('inpCal').value,
                pro: document.getElementById('inpPro').value,
                carb: document.getElementById('inpCarb').value,
                fat: document.getElementById('inpFat').value
            },
            notes: recipes.find(r => r.id === document.getElementById('editId').value)?.notes || "" 
        };
        if(document.getElementById('editId').value) d.id = document.getElementById('editId').value;
        saveRecipe(d);
    };

    // Image Upload
    document.getElementById('inpImage').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) { currentImageFile = null; return; }
        new Compressor(file, {
            quality: 0.6, maxWidth: 800, maxHeight: 600, convertSize: 500000, 
            success(result) {
                const reader = new FileReader();
                reader.onloadend = () => { currentImageFile = reader.result; };
                reader.readAsDataURL(result);
            },
            error(err) { alert("Image compression failed. Please try a different image or smaller file size."); console.error("Image compression error:", err); }
        });
    };
    
    // Search & Filter
    document.getElementById('searchInput').oninput = renderRecipeList;
    
    // Servings Scaling
    document.getElementById('detDesiredServings').oninput = (e) => {
        const r = recipes.find(x=>x.id===activeRecipeId);
        if(r) renderIngredientsInDetail(r, parseFloat(e.target.value)/parseFloat(r.originalServings));
    };

    // Notes Autosave
    document.getElementById('detNotes').onchange = async (e) => {
        if(activeRecipeId) {
            try {
                await updateDoc(doc(db, 'recipes', activeRecipeId), { notes: e.target.value });
                const r = recipes.find(x=>x.id===activeRecipeId);
                if(r) r.notes = e.target.value; 
            } catch(error) { console.error("Failed to save notes:", error); alert("Failed to save notes. Check Firebase rules."); }
        }
    };

    document.getElementById('btnPrint').onclick = () => window.print();

    // Add New Tag
    document.getElementById('btnAddCat').onclick = async () => {
        const inputField = document.getElementById('inpNewCat');
        const val = inputField.value.trim();
        if(val && !allTags.includes(val)) {
            allTags.push(val);
            allTags.sort();
            await saveGlobalTags(); 
            inputField.value = ''; 
        } else if (val) {
            alert(`Tag "${val}" already exists.`);
        }
    };

    // Meal Plan Week Select
    document.getElementById('mealPlanWeekSelect').onchange = () => { 
        renderMealPlanGrid(); 
        if(document.getElementById('shoppingView').style.display!=='none') renderShoppingList(); 
    };

    // Dark Mode Toggle
    document.getElementById('darkModeBtn').onclick = () => { 
        document.body.classList.toggle('dark-mode'); 
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        document.getElementById('darkModeBtn').textContent = document.body.classList.contains('dark-mode') ? '‚òÄ' : 'üåô';
    };

    // Stars Click (Add/Edit Modal)
    document.getElementById('inpRating').onclick = (e) => {
        if(e.target.tagName==='SPAN') {
            const v = parseInt(e.target.dataset.v);
            document.getElementById('inpRating').dataset.val = v;
            updateStars(document.getElementById('inpRating'), v);
        }
    };
    
    // Stars Click (Detail - Autosave)
    document.getElementById('detRating').onclick = async (e) => {
        if(e.target.tagName==='SPAN' && activeRecipeId) {
            const v = parseInt(e.target.dataset.v);
            updateStars(document.getElementById('detRating'), v);
            try {
                await updateDoc(doc(db, 'recipes', activeRecipeId), { rating: parseInt(v) });
                const r = recipes.find(x=>x.id===activeRecipeId);
                if(r) r.rating = parseInt(v); 
                renderRecipeList(); 
            } catch(error) { console.error("Failed to update rating:", error); alert("Failed to update rating. Check Firebase rules."); }
        }
    };

    // Shopping List Control Buttons
    document.getElementById('checkAllBtn').onclick = () => {
        document.querySelectorAll('#shoppingListContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
            checkbox.closest('.shopping-item').classList.add('checked');
        });
    };

    document.getElementById('clearCheckedBtn').onclick = () => {
        document.querySelectorAll('#shoppingListContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.shopping-item').classList.remove('checked');
        });
    };

    // Unit Converter Event Listeners
    document.getElementById('convertBtn').onclick = convertUnits;
    document.getElementById('convertInputQty').oninput = convertUnits;
    document.getElementById('convertInputUnit').onchange = convertUnits;
    document.getElementById('convertOutputUnit').onchange = convertUnits;

    // Delete button in Detail Modal
    document.getElementById('btnDeleteRecipeDetail').onclick = (e) => {
        const recipeIdToDelete = e.target.dataset.recipeId;
        if (recipeIdToDelete) {
            deleteRecipe(recipeIdToDelete);
        }
    };

    init();
</script>
</body>
</html>
