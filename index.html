<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beckner Recipes</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3565/3565418.png">
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <style>
        /* --- CSS Custom Properties --- */
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --header-color: #2c3e50;
            --container-bg: #fff;
            --border-color: #e0e0e0;
            --card-bg: #fff;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --button-primary: #007bff;
            --button-primary-hover: #0056b3;
            --button-danger: #dc3545;
            --meal-plan-day-bg: #fff;
            --meal-plan-header-bg: #007bff;
            --meal-plan-header-text: #fff;
            --modal-bg: #fff;
            --fav-color-filled: #ff4d4d;
            --fav-color-empty: #cccccc;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --header-color: #61dafb;
            --container-bg: #2d2d2d;
            --border-color: #444;
            --card-bg: #383838;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --button-primary: #61dafb;
            --button-primary-hover: #21a1f1;
            --meal-plan-day-bg: #383838;
            --meal-plan-header-bg: #444;
            --meal-plan-header-text: #61dafb;
            --modal-bg: #2d2d2d;
            --fav-color-filled: #ff7f7f;
            --fav-color-empty: #555555;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background-color: var(--container-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow-color); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .header-actions { display: flex; gap: 10px; }
        h1 { margin: 0; font-size: 1.8rem; color: var(--header-color); }

        /* Buttons & Inputs */
        button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
        .primary-btn { background: var(--button-primary); color: white; }
        .icon-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); font-size: 1.2rem; padding: 6px 12px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-color); box-sizing: border-box; margin-bottom: 10px; }

        .view-toggle { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .view-toggle button { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .view-toggle button.active { background: var(--button-primary); color: white; border-color: var(--button-primary); }

        /* Grid & Cards */
        #recipeList, #favoritesList { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .recipe-item { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px var(--shadow-color); position: relative; cursor: pointer; border: 1px solid var(--border-color); }
        .recipe-item img { width: 100%; height: 180px; object-fit: cover; }
        .recipe-item h3 { padding: 15px; margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .card-btn { background: rgba(255,255,255,0.95); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; border: none; }
        .card-btn.fav.active { color: var(--fav-color-filled); }

        /* Meal Plan */
        .meal-plan-calendar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .meal-day-column { background: var(--meal-plan-day-bg); border-radius: 10px; border: 1px solid var(--border-color); overflow: hidden; min-height: 200px; display: flex; flex-direction: column; }
        .meal-day-column.drag-over { box-shadow: 0 0 0 3px var(--button-primary); }
        .day-header { background: var(--meal-plan-header-bg); color: var(--meal-plan-header-text); padding: 8px; text-align: center; font-weight: bold; position: relative; }
        .add-meal-day-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .day-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .meal-card { background: var(--card-bg); border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px var(--shadow-color); position: relative; cursor: pointer; border: 1px solid var(--border-color); }
        .meal-card img { width: 100%; height: 80px; object-fit: cover; display: block; }
        .meal-card-title { padding: 6px; font-size: 0.85rem; font-weight: 500; }
        .remove-meal-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: none; }

        /* Shopping List */
        .shopping-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .shopping-item { display: flex; align-items: flex-start; background: var(--card-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .shopping-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; }
        .shopping-item.checked span { text-decoration: line-through; opacity: 0.6; }

        /* Nutrition */
        .nutrition-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .nutri-pill { text-align: center; background: var(--bg-color); padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .nutri-pill span { display: block; font-size: 0.8rem; opacity: 0.8; }
        .nutri-pill strong { font-size: 1.1rem; color: var(--button-primary); }

        /* Modals */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.75); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--modal-bg); border-radius: 12px; width: 95%; max-width: 1100px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .close-modal { background: none; border: none; font-size: 1.8rem; color: var(--text-color); cursor: pointer; padding: 0; line-height: 1; }

        /* Split View (Detail) */
        #detailModal .modal-content { height: 90vh; display: flex; flex-direction: column; }
        .split-view-container { display: flex; flex: 1; overflow: hidden; }
        .split-col { flex: 1; overflow-y: auto; padding: 20px 25px; }
        .split-col.left { flex: 0 0 35%; border-right: 1px solid var(--border-color); background: rgba(0,0,0,0.02); }
        @media (max-width: 768px) { .split-view-container { flex-direction: column; overflow-y: auto; } .split-col { overflow: visible; flex: none; } }
        
        .ingredient-list li { padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; }
        .ingredient-list li.checked { text-decoration: line-through; opacity: 0.5; }
        .stars span { font-size: 1.5rem; cursor: pointer; color: #ccc; }
        .stars span.filled { color: #ffc107; }
        
        /* Floating Timer */
        #timerIndicator { position: fixed; bottom: 25px; right: 25px; background: var(--header-color); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; display: none; z-index: 2000; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h1>Beckner Recipes</h1>
        <div class="header-actions">
            <button class="icon-btn" id="customTimerBtn">‚è± Timer</button>
            <button class="icon-btn" id="darkModeBtn">üåô</button>
        </div>
    </div>

    <div class="view-toggle">
        <button id="viewRecipesBtn" class="active">Recipes</button>
        <button id="viewMealPlanBtn">Meal Plan</button>
        <button id="viewShoppingBtn">Shopping List</button>
        <button id="viewFavoritesBtn">Favorites</button>
    </div>

    <!-- RECIPE CONTROLS -->
    <div id="recipeControls" class="top-bar" style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
        <button class="primary-btn" id="openAddModalBtn">+ Add Recipe</button>
        <input type="text" id="searchInput" placeholder="Search..." style="margin:0; flex-grow:1;">
        <select id="categoryFilter" style="margin:0; width:auto;">
            <option value="all">All Categories</option>
        </select>
    </div>

    <!-- VIEWS -->
    <div id="recipesView">
        <div id="recipeList"></div>
        <p id="emptyMessage" style="text-align:center; display:none; padding:20px;">No recipes found.</p>
    </div>

    <div id="mealPlanView" style="display: none;">
        <div style="text-align:center; margin-bottom:15px;">
            <select id="mealPlanWeekSelect" style="width: 200px; padding: 8px;">
                <option value="current">Current Week</option>
                <option value="next">Next Week</option>
            </select>
        </div>
        <div id="mealPlanGrid" class="meal-plan-calendar"></div>
    </div>

    <div id="shoppingView" style="display: none;">
        <div style="padding:15px; background:var(--card-bg); border-radius:8px; margin-bottom:15px;">
            <p style="margin:0;">Generates a list based on your Meal Plan selection.</p>
        </div>
        <div id="shoppingListContainer" class="shopping-list-container"></div>
    </div>

    <div id="favoritesView" style="display: none;">
        <div id="favoritesList"></div>
        <p id="emptyFavMessage" style="text-align:center; display:none; padding:20px;">No favorites yet.</p>
    </div>
</div>

<div id="timerIndicator">
    <span id="timerText">Timer: 00:00</span>
    <button id="cancelTimerBtn" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">‚úï</button>
</div>

<!-- ADD/EDIT MODAL -->
<div id="recipeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; display:block; padding:0;">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin:0;">Add Recipe</h2>
            <button class="close-modal close-add-modal">&times;</button>
        </div>
        <div style="padding: 20px;">
            <!-- JSON-LD IMPORT -->
            <div style="display:flex; gap:10px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed var(--border-color);">
                <textarea id="inpImportJson" placeholder="Paste Recipe JSON-LD Here (from page source)" rows="3" style="margin:0; flex-grow:1;"></textarea>
                <button type="button" id="btnImportJson" class="primary-btn" style="white-space:nowrap;">Parse JSON</button>
            </div>

            <form id="recipeForm">
                <input type="hidden" id="editId">
                <input type="text" id="inpTitle" placeholder="Recipe Title" required>
                <input type="url" id="inpSource" placeholder="Source URL">
                
                <div style="display:flex; gap:10px;">
                    <select id="inpCategory" style="flex:1;"></select>
                    <input type="text" id="inpNewCat" placeholder="New Cat." style="flex:1;">
                    <button type="button" id="btnAddCat" class="primary-btn">Add</button>
                </div>

                <label style="margin-top:10px; display:block; font-weight:bold;">Nutrition (Optional)</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="number" id="inpCal" placeholder="Cals" style="margin:0;">
                    <input type="number" id="inpPro" placeholder="Prot (g)" style="margin:0;">
                    <input type="number" id="inpCarb" placeholder="Carbs (g)" style="margin:0;">
                    <input type="number" id="inpFat" placeholder="Fat (g)" style="margin:0;">
                </div>

                <div style="display:flex; gap:10px; align-items: center; margin-bottom:10px; margin-top:10px;">
                    <input type="number" id="inpServings" placeholder="Servings" value="4" style="width:100px;">
                    <div class="stars" id="inpRating" data-val="0">
                        <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
                    </div>
                </div>

                <label>Image:</label>
                <input type="file" id="inpImage" accept="image/*">
                
                <label>Ingredients (one per line):</label>
                <textarea id="inpIngredients" rows="6" required placeholder="e.g.&#10;2 cups Flour&#10;1 tsp Salt"></textarea>
                
                <label>Instructions (one per line):</label>
                <textarea id="inpInstructions" rows="6" required placeholder="e.g.&#10;Preheat oven to 350&#10;Mix dry ingredients"></textarea>

                <button type="submit" class="primary-btn" id="btnSave" style="width:100%;">Save Recipe</button>
            </form>
        </div>
    </div>
</div>

<!-- SIMPLE SELECT MODAL FOR MEAL PLAN -->
<div id="selectRecipeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px; height:auto; padding:20px; display:block;">
        <h3 style="margin-top:0;">Add to <span id="targetDayName"></span></h3>
        <select id="mealPlanSelectDropdown" style="width:100%; padding:10px; font-size:1rem; margin-bottom:15px;"></select>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button id="cancelSelectBtn" style="background:none; border:1px solid #ccc;">Cancel</button>
            <button id="confirmSelectBtn" class="primary-btn">Add to Day</button>
        </div>
    </div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="detTitle" style="margin:0;">Recipe Title</h2>
            <button class="close-modal close-detail-modal">&times;</button>
        </div>
        
        <div class="detail-meta-bar">
            <span id="detCategory" class="detail-tag">Dinner</span>
            <div class="stars" id="detRating">
                <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
            </div>
            <a id="detSourceLink" href="#" target="_blank" class="source-link" style="display:none;">View Source ‚Üó</a>
            <div style="margin-left: auto; display:flex; gap:10px;">
                <button id="btnEditRecipe" class="primary-btn" style="padding:4px 10px; font-size:0.8rem;">Edit</button>
                <button id="btnPrint" class="primary-btn" style="padding:4px 10px; font-size:0.8rem;">Print</button>
            </div>
        </div>

        <div class="split-view-container">
            <div class="split-col left">
                <div id="detNutrition" class="nutrition-grid" style="display:none;">
                    <div class="nutri-pill"><span>Calories</span><strong id="valCal">0</strong></div>
                    <div class="nutri-pill"><span>Protein</span><strong id="valPro">0g</strong></div>
                    <div class="nutri-pill"><span>Carbs</span><strong id="valCarb">0g</strong></div>
                    <div class="nutri-pill"><span>Fat</span><strong id="valFat">0g</strong></div>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                    <label style="font-size:0.85rem; font-weight:bold;">Yields: <span id="detOrigServings"></span></label>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                        <span style="font-size:0.9rem;">Scale to:</span>
                        <input type="number" id="detDesiredServings" style="width:60px; margin:0; text-align:center;">
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3 style="border-bottom: 2px solid var(--header-color); padding-bottom:5px;">Ingredients</h3>
                    <ul id="detIngredients" class="ingredient-list"></ul>
                </div>
            </div>
            <div class="split-col right">
                <h3 style="border-bottom: 2px solid var(--header-color); padding-bottom:5px; margin-top:0;">Instructions</h3>
                <div id="detInstructions"></div>
                <h3 style="margin-top:30px;">Notes</h3>
                <textarea id="detNotes" placeholder="Personal notes..." style="min-height:100px;"></textarea>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); }); }

    const firebaseConfig = {
        apiKey: "AIzaSyA_5czSGHpYR8ZHMuB41mnIf5gL8zvLS6M",
        authDomain: "becknerrecipes.firebaseapp.com",
        projectId: "becknerrecipes",
        storageBucket: "becknerrecipes.firebasestorage.app",
        messagingSenderId: "563764688388",
        appId: "1:563764688388:web:dc5df2823ebcf0e1666751",
        measurementId: "G-SEC7ENVK7Y"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); 

    // --- STATE ---
    let recipes = [], favorites = [], mealPlan = {}, categories = []; 
    let currentImageFile = null, activeRecipeId = null, currentTimer = null;

    // --- INIT ---
    async function init() {
        await loadGlobalData();
        await loadRecipes();    
        renderCategories();
        showView('recipes'); 
        if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    }

    async function loadGlobalData() {
        try {
            const [favSnap, planSnap, catSnap] = await Promise.all([
                getDoc(doc(db, 'appData', 'favorites')),
                getDoc(doc(db, 'appData', 'mealPlan')),
                getDoc(doc(db, 'appData', 'categories'))
            ]);
            favorites = favSnap.exists() ? (favSnap.data().ids || []) : [];
            mealPlan = planSnap.exists() ? (planSnap.data().plan || {}) : {};
            categories = catSnap.exists() ? (catSnap.data().list || []) : ['Breakfast', 'Dinner'].sort();
        } catch(e) { console.log("New app or offline. Initializing default data."); }
    }

    async function loadRecipes() {
        try {
            const snap = await getDocs(collection(db, 'recipes'));
            recipes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch(e) { console.error("Failed to load recipes:", e); }
    }

    // --- UI RENDERING ---
    function renderCategories() {
        const sel = document.getElementById('categoryFilter');
        const inp = document.getElementById('inpCategory');
        const currentFilterValue = sel.value; // Remember selected value
        sel.innerHTML = '<option value="all">All Categories</option>';
        inp.innerHTML = ''; 
        categories.forEach(c => {
            sel.add(new Option(c, c));
            inp.add(new Option(c, c));
        });
        // Restore selected value or default to 'all'
        sel.value = Array.from(sel.options).some(o => o.value === currentFilterValue) ? currentFilterValue : 'all';
        inp.value = categories.length > 0 ? categories[0] : ''; // Default for input dropdown
    }

    function renderRecipeList() {
        const container = document.getElementById('recipeList');
        container.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        const filtered = recipes.filter(r => {
            const matchesSearch = !term || r.title.toLowerCase().includes(term) || (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(term)));
            const matchesCat = cat === 'all' || r.category === cat;
            return matchesSearch && matchesCat;
        });
        document.getElementById('emptyMessage').style.display = filtered.length ? 'none' : 'block';
        filtered.forEach(r => container.appendChild(createRecipeCard(r)));
    }

    function createRecipeCard(r) {
        const div = document.createElement('div');
        div.className = 'recipe-item';
        div.draggable = true; 
        div.dataset.recipeId = r.id; 
        
        div.innerHTML = `
            <img src="${r.imageData || 'https://via.placeholder.com/300x180?text=Food'}" loading="lazy">
            <div class="card-actions">
                <button class="card-btn fav ${favorites.includes(r.id)?'active':''}" data-id="${r.id}">‚ô•</button>
            </div>
            <h3>${r.title}</h3>
        `;
        div.querySelector('.fav').onclick = (e) => { e.stopPropagation(); toggleFavorite(r.id); };
        div.onclick = () => openDetail(r);
        div.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', r.id);
            e.dataTransfer.setData('source-type', 'list'); // Indicate drag is from recipe list (copy)
        });
        return div;
    }

    // --- JSON-LD IMPORT LOGIC ---
    document.getElementById('btnImportJson').onclick = () => {
        const jsonText = document.getElementById('inpImportJson').value;
        if(!jsonText) {
            alert("Please paste the JSON-LD data into the text area.");
            return;
        }
        
        try {
            let recipeData = JSON.parse(jsonText);

            // Helper to find the "Recipe" object inside the JSON-LD structure
            const findRecipe = (obj) => {
                if (obj && (obj['@type'] === 'Recipe' || (Array.isArray(obj['@type']) && obj['@type'].includes('Recipe')))) return obj;
                return null;
            };

            let foundRecipe = null;
            if (Array.isArray(recipeData)) {
                foundRecipe = recipeData.find(findRecipe);
            } else if (recipeData['@graph']) { // Common in some schemas
                foundRecipe = recipeData['@graph'].find(findRecipe);
            } else {
                foundRecipe = findRecipe(recipeData);
            }

            if (!foundRecipe) {
                alert("Could not find a valid 'Recipe' object in the provided JSON-LD.");
                return;
            }
            
            // Populate form fields
            document.getElementById('inpTitle').value = foundRecipe.name || "";
            document.getElementById('inpSource').value = foundRecipe.url || "";
            document.getElementById('inpServings').value = parseInt(foundRecipe.recipeYield) || 4;

            // Ingredients
            if (foundRecipe.recipeIngredient) {
                document.getElementById('inpIngredients').value = Array.isArray(foundRecipe.recipeIngredient) 
                    ? foundRecipe.recipeIngredient.join('\n') 
                    : foundRecipe.recipeIngredient;
            }

            // Instructions
            if (foundRecipe.recipeInstructions) {
                let instructions = [];
                if (Array.isArray(foundRecipe.recipeInstructions)) {
                    instructions = foundRecipe.recipeInstructions.map(step => step.text || step.name || step).filter(Boolean);
                } else {
                    instructions = [foundRecipe.recipeInstructions];
                }
                document.getElementById('inpInstructions').value = instructions.join('\n');
            }

            // Nutrition (if available)
            if (foundRecipe.nutrition) {
                document.getElementById('inpCal').value = parseInt(foundRecipe.nutrition.calories) || "";
                document.getElementById('inpPro').value = parseInt(foundRecipe.nutrition.proteinContent) || "";
                document.getElementById('inpCarb').value = parseInt(foundRecipe.nutrition.carbohydrateContent) || "";
                document.getElementById('inpFat').value = parseInt(foundRecipe.nutrition.fatContent) || "";
            } else { // Clear previous values if no nutrition found
                document.getElementById('inpCal').value = "";
                document.getElementById('inpPro').value = "";
                document.getElementById('inpCarb').value = "";
                document.getElementById('inpFat').value = "";
            }

            alert("Recipe data parsed! Please review and select a category before saving.");
            document.getElementById('inpImportJson').value = ''; // Clear the textarea
        } catch (error) {
            alert("Error parsing JSON: " + error.message + "\nPlease ensure you've pasted valid JSON-LD.");
            console.error("JSON-LD parse error:", error);
        }
    };

    // --- MEAL PLAN & SHOPPING ---
    function renderMealPlanGrid() {
        const grid = document.getElementById('mealPlanGrid');
        grid.innerHTML = '';
        const week = document.getElementById('mealPlanWeekSelect').value;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        days.forEach(day => {
            const dayKey = `${week}-${day.toLowerCase()}`;
            const col = document.createElement('div');
            col.className = 'meal-day-column';
            col.dataset.dayKey = dayKey; 
            
            col.innerHTML = `
                <div class="day-header">
                    ${day}
                    <button class="add-meal-day-btn" data-key="${dayKey}">+</button>
                </div>
                <div class="day-content"></div>
            `;

            // Add Recipe to Day button logic
            col.querySelector('.add-meal-day-btn').onclick = (e) => {
                e.stopPropagation(); // Prevent drag-drop issues
                openSelectModal(dayKey, day);
            };

            const content = col.querySelector('.day-content');
            
            // DRAG & DROP LOGIC
            content.addEventListener('dragover', (e) => { e.preventDefault(); col.classList.add('drag-over'); });
            content.addEventListener('dragleave', () => col.classList.remove('drag-over'));
            
            content.addEventListener('drop', async (e) => {
                e.preventDefault();
                col.classList.remove('drag-over');
                const recipeId = e.dataTransfer.getData('text/plain');
                const sourceType = e.dataTransfer.getData('source-type'); // 'list' or 'plan'
                const sourceDayKey = e.dataTransfer.getData('source-day'); // Only for 'plan' type drags
                
                if (!recipeId) return;

                if (!mealPlan[dayKey]) mealPlan[dayKey] = [];

                if (sourceType === 'plan' && sourceDayKey && sourceDayKey !== dayKey) {
                    // This is a MOVE operation from one day to another
                    mealPlan[sourceDayKey] = mealPlan[sourceDayKey].filter(id => id !== recipeId);
                    if (mealPlan[sourceDayKey].length === 0) delete mealPlan[sourceDayKey]; // Clean up empty day
                    
                    // Add to new day if not already there (shouldn't be, but good check)
                    if (!mealPlan[dayKey].includes(recipeId)) {
                        mealPlan[dayKey].push(recipeId);
                    }
                    console.log(`Moved recipe ${recipeId} from ${sourceDayKey} to ${dayKey}`);
                } else if (sourceType === 'list') {
                    // This is a COPY operation from the main recipe list
                    if (mealPlan[dayKey].includes(recipeId)) {
                        alert("Recipe already on this day's plan.");
                    } else {
                        mealPlan[dayKey].push(recipeId);
                        console.log(`Copied recipe ${recipeId} to ${dayKey}`);
                    }
                } else if (sourceType === 'plan' && sourceDayKey === dayKey) {
                    // Dragging within the same day - no change in mealPlan content needed, just visual reorder
                    // If you wanted to allow reordering, you'd need more complex logic here
                    console.log(`Dragged recipe ${recipeId} within ${dayKey} (no change to order for now)`);
                }

                await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
                renderMealPlanGrid(); // Re-render the entire grid to reflect changes
            });

            (mealPlan[dayKey] || []).forEach(id => {
                const r = recipes.find(x => x.id === id);
                if(r) content.appendChild(createMealCardElement(r, dayKey));
            });
            grid.appendChild(col);
        });
    }

    function createMealCardElement(r, dayKey) {
        const card = document.createElement('div');
        card.className = 'meal-card';
        card.draggable = true;
        card.dataset.recipeId = r.id; // Store recipe ID
        
        card.innerHTML = `<img src="${r.imageData || 'https://via.placeholder.com/150x90?text=Food'}" loading="lazy"><div class="meal-card-title">${r.title}</div><button class="remove-meal-btn">‚úï</button>`;
        
        card.querySelector('.remove-meal-btn').onclick = async (e) => {
            e.stopPropagation();
            mealPlan[dayKey] = mealPlan[dayKey].filter(x => x !== r.id);
            if (mealPlan[dayKey].length === 0) delete mealPlan[dayKey]; // Clean up empty day
            await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
            renderMealPlanGrid();
        };
        
        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', r.id);
            e.dataTransfer.setData('source-type', 'plan'); // Indicate drag is from meal plan (move potential)
            e.dataTransfer.setData('source-day', dayKey); // Store source day key
        });
        
        card.onclick = () => openDetail(r);
        return card;
    }

    // Manual Add Modal for Meal Plan Days
    let targetDayKeyForAdd = null;
    function openSelectModal(dayKey, dayName) {
        targetDayKeyForAdd = dayKey;
        document.getElementById('targetDayName').textContent = dayName;
        const sel = document.getElementById('mealPlanSelectDropdown');
        sel.innerHTML = '<option value="">Select a Recipe...</option>';
        // Sort recipes alphabetically
        [...recipes].sort((a,b) => a.title.localeCompare(b.title)).forEach(r => {
            sel.add(new Option(r.title, r.id));
        });
        document.getElementById('selectRecipeModal').classList.add('active');
    }

    document.getElementById('confirmSelectBtn').onclick = async () => {
        const rid = document.getElementById('mealPlanSelectDropdown').value;
        if(rid && targetDayKeyForAdd) {
            if(!mealPlan[targetDayKeyForAdd]) mealPlan[targetDayKeyForAdd] = [];
            if(mealPlan[targetDayKeyForAdd].includes(rid)) {
                alert("Recipe already on this day's plan.");
            } else {
                mealPlan[targetDayKeyForAdd].push(rid);
                await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });
                renderMealPlanGrid();
            }
            document.getElementById('selectRecipeModal').classList.remove('active');
        } else {
            alert("Please select a recipe.");
        }
    };
    document.getElementById('cancelSelectBtn').onclick = () => document.getElementById('selectRecipeModal').classList.remove('active');


    // --- SHOPPING & FRACTIONS ---
    function formatFraction(d) {
        if (typeof d !== 'number' || isNaN(d)) return "";
        const tolerance = 0.005; // Adjusted tolerance for better matching
        const whole = Math.floor(d);
        const rem = d - whole;

        // Check for exact whole numbers
        if (Math.abs(rem) < tolerance) return Math.round(d).toString();

        const fracs = {
            0.125: "‚Öõ", 0.166: "‚Öô", 0.2: "‚Öï", 0.25: "¬º", 0.333: "‚Öì", 0.375: "‚Öú",
            0.4: "‚Öñ", 0.5: "¬Ω", 0.6: "‚Öó", 0.625: "‚Öù", 0.666: "‚Öî", 0.75: "¬æ",
            0.8: "‚Öò", 0.833: "‚Öö", 0.875: "‚Öû"
        };
        
        let closestFractionSymbol = "";
        let minDiff = 1; // Start with a larger difference

        for (let key in fracs) {
            const val = parseFloat(key);
            if (Math.abs(val - rem) < minDiff) {
                minDiff = Math.abs(val - rem);
                closestFractionSymbol = fracs[key];
            }
        }

        if (closestFractionSymbol && minDiff < tolerance * 2) { // Use a slightly looser tolerance for selection than for whole numbers
            return whole > 0 ? `${whole} ${closestFractionSymbol}` : closestFractionSymbol;
        }
        // Fallback to 2 decimals if no good fraction match
        return d.toFixed(2).replace(/\.?0+$/, ''); // Remove trailing .00 or .0
    }

    function renderShoppingList() {
        const div = document.getElementById('shoppingListContainer');
        div.innerHTML = '';
        const week = document.getElementById('mealPlanWeekSelect').value;
        const rawList = [];
        
        Object.keys(mealPlan).filter(k => k.startsWith(week)).forEach(k => {
            mealPlan[k].forEach(rid => {
                const r = recipes.find(x => x.id === rid);
                if(r) rawList.push(...r.ingredients);
            });
        });

        const agg = {};
        rawList.forEach(line => {
            // Updated regex to better handle non-numeric starts like "a pinch of salt"
            const m = line.match(/^(\d+(\.\d+)?|\d+\s*\d*\/\d+|\d+\/\d+)?\s*(.*)/); // Matches optional number/fraction, then rest
            
            if(m && m[3]) { // m[3] is the ingredient name after quantity
                let qtyStr = (m[1] || '').trim();
                let item = m[3].trim().toLowerCase();

                // Basic item normalization (singularization)
                if(item.endsWith('s') && item.length > 3 && !item.endsWith('ss')) { // avoid 'less' -> 'le'
                     item = item.slice(0,-1);
                }
                
                let val = 0;
                if(qtyStr) { // If a quantity was matched
                    if(qtyStr.includes('/')) { // Handle mixed fractions "1 1/2" or just "1/2"
                        qtyStr.split(' ').forEach(p => {
                            if(p.includes('/')) { const[n,d]=p.split('/'); val+=(+n/+d); } else val+=+p;
                        });
                    } else val = parseFloat(qtyStr);
                } else { // No quantity found, assume 1 (e.g., "1 large onion" is better than "large onion")
                    val = 1; 
                }
                
                if(!agg[item]) agg[item] = {val:0, name:item};
                agg[item].val += val;
            } else { // No quantity or name, just add the whole line
                if(!agg[line]) agg[line] = {val:0, name:line, raw:true};
                else agg[line].val++; // Count raw lines too
            }
        });

        Object.values(agg).sort((a,b) => a.name.localeCompare(b.name)).forEach(i => {
            const d = document.createElement('div');
            d.className = 'shopping-item';
            d.innerHTML = `<input type="checkbox"><span>${i.raw ? i.name : formatFraction(i.val) + ' ' + i.name}</span>`;
            d.querySelector('input').onclick = (e) => e.target.checked ? d.classList.add('checked') : d.classList.remove('checked');
            div.appendChild(d);
        });
    }

    // --- GENERIC ACTIONS ---
    async function toggleFavorite(id) {
        favorites.includes(id) ? favorites=favorites.filter(x=>x!==id) : favorites.push(id);
        await setDoc(doc(db,'appData','favorites'), {ids:favorites});
        // Re-render appropriate lists
        if(document.getElementById('viewFavoritesBtn').classList.contains('active')) renderFavoritesList();
        else renderRecipeList();
    }

    async function deleteRecipe(id) {
        if(!confirm("Permanently delete this recipe?")) return;
        const recipeToDelete = recipes.find(r => r.id === id);
        try {
            if (recipeToDelete && recipeToDelete.imageData && recipeToDelete.imageData.startsWith('https://firebasestorage.googleapis.com/')) {
                try { await deleteObject(ref(storage, recipeToDelete.imageData)); } catch (err) { console.warn("Image deletion failed:", err); }
            }
            await deleteDoc(doc(db, 'recipes', id));
            
            // Cleanup from global lists
            favorites = favorites.filter(x => x !== id); await setDoc(doc(db,'appData','favorites'), {ids:favorites});
            
            let mealPlanChanged = false;
            Object.keys(mealPlan).forEach(k => {
                if(mealPlan[k].includes(id)) {
                    mealPlan[k] = mealPlan[k].filter(x => x !== id);
                    if(mealPlan[k].length === 0) delete mealPlan[k];
                    mealPlanChanged = true;
                }
            });
            if(mealPlanChanged) await setDoc(doc(db, 'appData', 'mealPlan'), { plan: mealPlan });

            await loadRecipes(); 
            // Re-render the current active view
            showView(document.querySelector('.view-toggle button.active').id.replace('view','').toLowerCase().replace('btn','')); 
        } catch (e) { alert("Error deleting recipe."); console.error(e); }
    }

    async function saveRecipe(data) {
        const btn = document.getElementById('btnSave'); btn.textContent="Saving..."; btn.disabled=true;
        try {
            if(currentImageFile) {
                const snap = await uploadString(ref(storage, `img_${Date.now()}`), currentImageFile, 'data_url');
                data.imageData = await getDownloadURL(snap.ref);
            } else if (data.id) { // Keep existing image if not uploading new one
                const old = recipes.find(r=>r.id===data.id);
                if(old) data.imageData = old.imageData;
            }
            if(data.id) await updateDoc(doc(db,'recipes',data.id), data);
            else await addDoc(collection(db,'recipes'), data);
            
            await loadRecipes();
            showView('recipes');
            document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'));
        } catch(e) { alert("Save Error"); console.error(e); }
        btn.textContent="Save Recipe"; btn.disabled=false;
    }

    // --- MODALS AND DETAILS ---
    function openDetail(r) {
        activeRecipeId = r.id; // Set for edit/notes save
        document.getElementById('detTitle').textContent = r.title;
        document.getElementById('detCategory').textContent = r.category;
        document.getElementById('detOrigServings').textContent = r.originalServings;
        document.getElementById('detDesiredServings').value = r.originalServings;
        document.getElementById('detNotes').value = r.notes || '';
        
        // Nutrition
        const nGrid = document.getElementById('detNutrition');
        if(r.nutrition && (r.nutrition.cal || r.nutrition.pro || r.nutrition.carb || r.nutrition.fat)) {
            nGrid.style.display='grid';
            document.getElementById('valCal').textContent = r.nutrition.cal || 0;
            document.getElementById('valPro').textContent = (r.nutrition.pro || 0)+'g';
            document.getElementById('valCarb').textContent = (r.nutrition.carb || 0)+'g';
            document.getElementById('valFat').textContent = (r.nutrition.fat || 0)+'g';
        } else nGrid.style.display='none';

        // Source Link
        const srcLink = document.getElementById('detSourceLink');
        if(r.source && r.source.trim() !== '') {
            srcLink.href = r.source; srcLink.style.display = 'block';
        } else srcLink.style.display = 'none';

        updateStars(document.getElementById('detRating'), r.rating || 0);
        renderIngredients(r, 1);

        // Instructions
        const div = document.getElementById('detInstructions'); div.innerHTML='';
        r.instructions.forEach((s,i) => {
            const d = document.createElement('div'); d.className='instruction-step';
            d.innerHTML = `<strong>Step ${i+1}</strong> ${s}`;
            div.appendChild(d);
        });

        document.getElementById('detailModal').classList.add('active');
        //requestWakeLock(); // Removed wakeLock as it's not strictly necessary for viewing
    }

    function renderIngredients(r, scale) {
        const list = document.getElementById('detIngredients');
        list.innerHTML = '';
        
        r.ingredients.forEach(ing => {
            const li = document.createElement('li');
            li.onclick = () => li.classList.toggle('checked');
            
            const match = ing.match(/^(\d+(\.\d+)?|\d+\s*\d*\/\d+|\d+\/\d+)?\s*(.*)/);
            if(match && match[3]) { // Quantity (optional) and the rest of the ingredient
                let qtyStr = (match[1] || '').trim();
                let rest = match[3].trim();
                let val = 0;

                if(qtyStr) {
                    if(qtyStr.includes('/')) {
                        qtyStr.split(' ').forEach(p => {
                            if(p.includes('/')) { const [n,d]=p.split('/'); val+=(+n/+d); } else val+=+p;
                        });
                    } else val = parseFloat(qtyStr);
                } else { // No quantity matched, just display rest
                     li.textContent = ing; // Fallback to original if no number
                     list.appendChild(li);
                     return;
                }

                if(isNaN(val)) {
                    li.textContent = ing; // Fallback to original if parse fails
                } else {
                    const final = val * scale;
                    li.innerHTML = `<span>${formatFraction(final)}</span> ${rest}`;
                }
            } else { // No quantity found, or malformed, display as is
                li.textContent = ing;
            }
            list.appendChild(li);
        });
    }

    function updateStars(el, val) {
        Array.from(el.children).forEach(s => s.classList.toggle('filled', parseInt(s.getAttribute('data-v')) <= val));
    }

    // --- EVENT LISTENERS ---
    
    // Timer functions (unchanged)
    document.getElementById('customTimerBtn').onclick = () => {
        const minStr = prompt("Enter minutes for timer:", "5");
        if(minStr && !isNaN(parseFloat(minStr))) runTimer(parseFloat(minStr), "Custom");
    };
    document.getElementById('cancelTimerBtn').onclick = () => {
        if(currentTimer) clearInterval(currentTimer);
        document.getElementById('timerIndicator').style.display = 'none';
        currentTimer = null;
    };
    function runTimer(min, txt) { /* ... existing timer logic ... */ }
    function stopTimer() { /* ... existing timer logic ... */ }

    // View Switching
    ['recipes','mealPlan','shopping','favorites'].forEach(v => {
        document.getElementById(`view${v.charAt(0).toUpperCase()+v.slice(1)}Btn`).onclick = () => showView(v);
    });
    function showView(v) {
        document.querySelectorAll('.view-toggle button').forEach(b=>b.classList.remove('active'));
        document.getElementById(`view${v.charAt(0).toUpperCase()+v.slice(1)}Btn`).classList.add('active');
        ['recipes','mealPlan','shopping','favorites'].forEach(x=>document.getElementById(`${x}View`).style.display='none');
        document.getElementById(`${v}View`).style.display='block';
        document.getElementById('recipeControls').style.display = v==='recipes'?'flex':'none';
        if(v==='recipes') renderRecipeList();
        else if(v==='mealPlan') renderMealPlanGrid();
        else if(v==='shopping') renderShoppingList();
        else if(v==='favorites') renderFavoritesList();
    }

    // Modal Triggers
    document.getElementById('openAddModalBtn').onclick = () => {
        document.getElementById('recipeForm').reset();
        document.getElementById('editId').value = "";
        document.getElementById('inpSource').value = "";
        document.getElementById('inpImportJson').value = ""; // Clear import textarea
        currentImageFile = null; 
        updateStars(document.getElementById('inpRating'), 0);
        document.getElementById('modalTitle').textContent = "Add New Recipe";
        document.getElementById('recipeModal').classList.add('active');
    };
    document.querySelectorAll('.close-modal').forEach(b=>b.onclick=()=>document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active')));

    // Edit Button in Detail View
    document.getElementById('btnEditRecipe').onclick = () => {
        const r = recipes.find(x=>x.id===activeRecipeId);
        if(!r) return;
        document.getElementById('detailModal').classList.remove('active');
        
        document.getElementById('editId').value = r.id;
        document.getElementById('inpTitle').value = r.title;
        document.getElementById('inpSource').value = r.source || "";
        document.getElementById('inpCategory').value = r.category;
        document.getElementById('inpServings').value = r.originalServings;
        document.getElementById('inpIngredients').value = r.ingredients.join('\n');
        document.getElementById('inpInstructions').value = r.instructions.join('\n');
        
        // Load Nutrition for editing
        if(r.nutrition) {
            document.getElementById('inpCal').value = r.nutrition.cal || "";
            document.getElementById('inpPro').value = r.nutrition.pro || "";
            document.getElementById('inpCarb').value = r.nutrition.carb || "";
            document.getElementById('inpFat').value = r.nutrition.fat || "";
        } else {
            document.getElementById('inpCal').value = ""; document.getElementById('inpPro').value = "";
            document.getElementById('inpCarb').value = ""; document.getElementById('inpFat').value = "";
        }

        updateStars(document.getElementById('inpRating'), r.rating);
        document.getElementById('inpRating').dataset.val = r.rating;
        currentImageFile = null; 
        
        document.getElementById('recipeModal').classList.add('active');
    };

    // Form Submit
    document.getElementById('recipeForm').onsubmit = (e) => {
        e.preventDefault();
        const d = {
            title: document.getElementById('inpTitle').value,
            source: document.getElementById('inpSource').value,
            category: document.getElementById('inpCategory').value,
            originalServings: document.getElementById('inpServings').value,
            ingredients: document.getElementById('inpIngredients').value.split('\n').filter(x=>x.trim()),
            instructions: document.getElementById('inpInstructions').value.split('\n').filter(x=>x.trim()),
            rating: parseInt(document.getElementById('inpRating').dataset.val || 0),
            nutrition: {
                cal: document.getElementById('inpCal').value,
                pro: document.getElementById('inpPro').value,
                carb: document.getElementById('inpCarb').value,
                fat: document.getElementById('inpFat').value
            },
            notes: recipes.find(r => r.id === document.getElementById('editId').value)?.notes || "" // Preserve notes on edit
        };
        if(document.getElementById('editId').value) d.id = document.getElementById('editId').value;
        saveRecipe(d);
    };

    // Image Upload
    document.getElementById('inpImage').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) { currentImageFile = null; return; }
        new Compressor(file, {
            quality: 0.6, maxWidth: 800, maxHeight: 600, convertSize: 500000, 
            success(result) {
                const reader = new FileReader();
                reader.onloadend = () => { currentImageFile = reader.result; };
                reader.readAsDataURL(result);
            },
            error(err) { alert("Image compression failed. Please try a different image or smaller file size."); console.error("Image compression error:", err); }
        });
    };
    
    // Search & Filter
    document.getElementById('searchInput').oninput = renderRecipeList;
    document.getElementById('categoryFilter').onchange = renderRecipeList;
    
    // Servings Scaling
    document.getElementById('detDesiredServings').oninput = (e) => {
        const r = recipes.find(x=>x.id===activeRecipeId);
        if(r) renderIngredients(r, parseFloat(e.target.value)/parseFloat(r.originalServings));
    };

    // Notes Autosave
    document.getElementById('detNotes').onchange = async (e) => {
        if(activeRecipeId) {
            try {
                await updateDoc(doc(db, 'recipes', activeRecipeId), { notes: e.target.value });
                const r = recipes.find(x=>x.id===activeRecipeId);
                if(r) r.notes = e.target.value; // Update local state
            } catch(error) { console.error("Failed to save notes:", error); alert("Failed to save notes. Check Firebase rules."); }
        }
    };

    document.getElementById('btnPrint').onclick = () => window.print();

    // Add New Category
    document.getElementById('btnAddCat').onclick = async () => {
        const val = document.getElementById('inpNewCat').value.trim();
        if(val && !categories.includes(val)) {
            categories.push(val); categories.sort();
            await setDoc(doc(db, 'appData', 'categories'), { list: categories });
            renderCategories(); 
            document.getElementById('inpCategory').value = val; // Select the new category
            document.getElementById('inpNewCat').value = ''; 
        } else if (val) {
            alert(`Category "${val}" already exists.`);
        }
    };

    // Meal Plan Week Select
    document.getElementById('mealPlanWeekSelect').onchange = () => { 
        renderMealPlanGrid(); 
        if(document.getElementById('shoppingView').style.display!=='none') renderShoppingList(); 
    };

    // Dark Mode Toggle
    document.getElementById('darkModeBtn').onclick = () => { 
        document.body.classList.toggle('dark-mode'); 
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        document.getElementById('darkModeBtn').textContent = document.body.classList.contains('dark-mode') ? '‚òÄ' : 'üåô';
    };

    // Stars Click (Add/Edit Modal)
    document.getElementById('inpRating').onclick = (e) => {
        if(e.target.tagName==='SPAN') {
            const v = parseInt(e.target.dataset.v);
            document.getElementById('inpRating').dataset.val = v;
            updateStars(document.getElementById('inpRating'), v);
        }
    };
    
    // Stars Click (Detail - Autosave)
    document.getElementById('detRating').onclick = async (e) => {
        if(e.target.tagName==='SPAN' && activeRecipeId) {
            const v = parseInt(e.target.dataset.v);
            updateStars(document.getElementById('detRating'), v);
            try {
                await updateDoc(doc(db, 'recipes', activeRecipeId), { rating: parseInt(v) });
                const r = recipes.find(x=>x.id===activeRecipeId);
                if(r) r.rating = parseInt(v); 
                renderRecipeList(); // Update main list to reflect new rating
            } catch(error) { console.error("Failed to update rating:", error); alert("Failed to update rating. Check Firebase rules."); }
        }
    };

    init();
</script>
</body>
</html>
