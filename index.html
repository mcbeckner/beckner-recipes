<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beckner Recipes</title>
    <style>
        /* --- CSS Custom Properties (Variables) for theming --- */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --header-color: #2c3e50;
            --container-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #fcfcfc;
            --card-shadow: rgba(0, 0, 0, 0.08);
            --input-border: #ccc;
            --input-focus-border: #007bff;
            --button-primary: #007bff;
            --button-primary-hover: #0056b3;
            --button-success: #28a745;
            --button-success-hover: #218838;
            --button-info: #17a2b8;
            --button-info-hover: #138496;
            --button-danger: #dc3545;
            --button-danger-hover: #c82333;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --modal-bg: #fff;
            --modal-shadow: rgba(0, 0, 0, 0.3);
            --warning-bg: #fff3cd;
            --warning-border: #ffeeba;
            --warning-text: #856404;
            --pre-bg: #f8f9fa;
            --pre-border: #e9ecef;
            --category-tag-bg: #e0f7fa;
            --category-tag-text: #007bff;
            --detail-meta-bg: #e9f7ef;
            --detail-meta-text: #28a745;
            --star-color-filled: #ffc107;
            --star-color-empty: #e4e5e9;
            --ingredient-checked-color: #777;
            --favorite-color: #ff4d4d;
            --meal-plan-bg: #f0f8ff;
            --meal-plan-border: #cce5ff;
        }

        body.dark-mode {
            --bg-color: #282c34;
            --text-color: #e0e0e0;
            --header-color: #61dafb;
            --container-bg: #3c414d;
            --border-color: #4a4f5d;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --card-bg: #363a44;
            --card-shadow: rgba(0, 0, 0, 0.2);
            --input-border: #555;
            --input-focus-border: #61dafb;
            --button-primary: #61dafb;
            --button-primary-hover: #21a1f1;
            --button-success: #4CAF50;
            --button-success-hover: #45a049;
            --button-info: #00bcd4;
            --button-info-hover: #0097a7;
            --button-danger: #f44336;
            --button-danger-hover: #da190b;
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --modal-bg: #3c414d;
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --warning-bg: #5a5220;
            --warning-border: #8c7f3e;
            --warning-text: #ffeeba;
            --pre-bg: #4a4f5d;
            --pre-border: #555;
            --category-tag-bg: #1e3a47;
            --category-tag-text: #61dafb;
            --detail-meta-bg: #3a473d;
            --detail-meta-text: #4CAF50;
            --star-color-filled: #ffeb3b;
            --star-color-empty: #777;
            --ingredient-checked-color: #aaa;
            --favorite-color: #ff7f7f;
            --meal-plan-bg: #2a3b4d;
            --meal-plan-border: #3a5670;
        }

        /* --- General Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        h1, h2 {
            color: var(--header-color);
            text-align: center;
            margin-bottom: 25px;
            transition: color 0.3s ease;
        }

        h1 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 40px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select,
        input[type="file"] {
            width: calc(100% - 22px);
            padding: 12px 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .category-input-group {
            display: flex;
            gap: 10px;
        }

        .category-input-group input {
            flex-grow: 1;
        }

        .category-input-group button {
            width: auto;
            padding: 8px 15px;
            margin: 0;
            font-size: 0.9em;
            background-color: var(--button-primary);
        }
        .category-input-group button:hover {
             background-color: var(--button-primary-hover);
        }

        .top-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        button {
            background-color: var(--button-success);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: var(--button-success-hover);
            transform: translateY(-2px);
        }

        .top-buttons .primary-btn {
            background-color: var(--button-primary);
            margin: 0;
        }
        .top-buttons .primary-btn:hover {
            background-color: var(--button-primary-hover);
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        #controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #controls label {
            margin-bottom: 0;
            font-weight: normal;
        }

        #recipeSearchInput {
            flex-grow: 1;
            min-width: 150px;
        }

        #sortSelect, #filterCategorySelect {
            width: 180px;
            padding: 8px;
            font-size: 0.95em;
        }

        #dark-mode-toggle {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            margin-left: 20px;
            transition: color 0.3s ease;
        }
        #dark-mode-toggle:hover {
            color: var(--header-color);
            transform: scale(1.1);
        }

        #recipeList {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .recipe-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--card-shadow);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .recipe-item:hover {
            transform: translateY(-5px);
        }

        .recipe-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
            display: block;
        }

        .recipe-item h3 {
            color: var(--button-primary);
            margin: 15px 10px;
            font-size: 1.4em;
            text-align: center;
            line-height: 1.3;
            min-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            transition: color 0.3s ease;
        }

        .recipe-item .delete-btn {
            background-color: var(--button-danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8em;
            position: absolute;
            top: 8px;
            right: 8px;
            transition: background-color 0.2s ease;
            z-index: 10;
        }

        .recipe-item .delete-btn:hover {
            background-color: var(--button-danger-hover);
        }

        .recipe-item .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            color: var(--star-color-empty);
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .recipe-item .favorite-btn.favorited {
            color: var(--favorite-color);
        }

        .recipe-item .favorite-btn:hover {
            transform: scale(1.2);
        }

        .empty-state {
            text-align: center;
            font-style: italic;
            color: var(--text-color);
            margin-top: 30px;
            font-size: 1.1em;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--modal-shadow);
            width: 90%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 2em;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: var(--button-danger);
        }

        /* Recipe Detail View (Cooking View) Layout */
        #recipeDetailModalContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        #recipeDetailModalContent .detail-section {
            flex: 1;
            min-width: 380px;
            font-size: 1.1em;
        }

        #recipeDetailModalContent h3 {
            font-size: 1.5em;
            color: var(--button-primary);
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        #recipeDetailModalContent ul,
        #recipeDetailModalContent ol {
            padding-left: 25px;
            margin-top: 0;
            list-style-position: inside;
        }

        #recipeDetailModalContent li {
            margin-bottom: 10px;
        }

        /* Styling for ingredient checklist */
        #recipeDetailModalContent .ingredient-item {
            cursor: pointer;
            user-select: none;
            list-style-type: disc;
        }

        #recipeDetailModalContent .ingredient-item.checked {
            text-decoration: line-through;
            color: var(--ingredient-checked-color);
        }

        /* Styling for instruction timers */
        #recipeDetailModalContent .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        #recipeDetailModalContent .instruction-item .timer-btn {
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 5px;
            background-color: var(--button-primary);
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        #recipeDetailModalContent .instruction-item .timer-btn:hover {
            background-color: var(--button-primary-hover);
        }
        /* Timer indicator */
        .timer-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-danger);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .recipe-detail-meta {
            font-size: 0.95em;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-color);
        }
        .recipe-detail-meta span {
            display: inline-block;
            background-color: var(--detail-meta-bg);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: bold;
            color: var(--detail-meta-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .image-upload-warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Rating Stars */
        .rating-stars {
            display: inline-block;
            font-size: 1.5em;
            color: var(--star-color-empty);
            letter-spacing: -2px;
        }
        .rating-stars span {
            cursor: pointer;
            transition: color 0.2s;
            display: inline-block;
            padding: 0 2px;
        }
        .rating-stars span.filled {
            color: var(--star-color-filled);
        }
        .rating-input-group .rating-stars {
            margin-left: 10px;
            font-size: 2em;
            vertical-align: middle;
            color: var(--star-color-empty);
        }
        .rating-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .rating-input-group label {
            margin-bottom: 0;
        }

        /* Servings Scaling */
        .servings-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .servings-control label {
            margin: 0;
            white-space: nowrap;
        }
        .servings-control input[type="number"] {
            width: 80px;
            text-align: center;
            padding: 8px 5px;
            height: auto;
        }
        .scaling-warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        /* Recipe Notes */
        #recipeNotes {
            width: 100%;
            min-height: 150px;
            box-sizing: border-box;
        }

        /* Print Button */
        .print-btn {
            background-color: var(--button-info);
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border-radius: 5px;
        }
        .print-btn:hover {
            background-color: var(--button-info-hover);
        }

        /* Meal Planning Styles */
        .meal-plan-section {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--meal-plan-bg);
            border: 1px solid var(--meal-plan-border);
            border-radius: 12px;
        }

        .meal-plan-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .meal-plan-controls select,
        .meal-plan-controls input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        .meal-plan-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .meal-plan-day {
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            min-height: 150px;
        }

        .meal-plan-day-header {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .meal-plan-recipe {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            cursor: move;
            font-size: 0.9em;
            position: relative;
        }
        
        .meal-plan-recipe-link {
            color: var(--button-primary);
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        .meal-plan-recipe-link:hover {
            text-decoration: underline;
        }

        .meal-plan-recipe .remove-meal {
            position: absolute;
            top: 4px;
            right: 4px;
            background: none;
            border: none;
            color: var(--button-danger);
            cursor: pointer;
            font-size: 1.2em;
        }

        .meal-plan-recipe .remove-meal:hover {
            color: var(--button-danger-hover);
        }

        /* Edit Button in Detail Modal */
        .edit-recipe-btn {
            background-color: var(--button-info);
            margin-right: 10px;
        }

        .edit-recipe-btn:hover {
            background-color: var(--button-info-hover);
        }

        /* View Toggle Buttons */
        .view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .view-toggle button {
            padding: 10px 20px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .view-toggle button.active {
            background-color: var(--button-primary);
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container, .modal-content {
                padding: 15px;
                margin: 10px auto;
            }
            h1 {
                font-size: 2em;
            }
            h2 {
                font-size: 1.5em;
            }
            .recipe-item h3 {
                font-size: 1.2em;
            }
            #recipeDetailModalContent .detail-section {
                min-width: 100%;
            }
            .category-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            .category-input-group button {
                width: 100%;
            }
            .top-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .top-buttons button {
                width: 100%;
            }
            #sortSelect, #filterCategorySelect, #recipeSearchInput {
                width: 100%;
            }
            #dark-mode-toggle {
                margin-left: 0;
            }
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            #controls > div {
                justify-content: space-between;
                width: 100%;
                flex-wrap: wrap;
            }
            #controls > div:last-child {
                justify-content: space-between;
                width: 100%;
            }
            .servings-control {
                flex-direction: column;
            }
            .meal-plan-calendar {
                grid-template-columns: repeat(1, 1fr);
            }
            .meal-plan-controls {
                flex-direction: column;
            }
        }

        /* --- Print Styles --- */
        @media print {
            body > *:not(.modal-overlay.active) {
                display: none !important;
            }
            .modal-overlay.active {
                position: static;
                background-color: transparent !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 100%;
                height: auto;
                overflow: visible;
                margin: 0;
                padding: 0;
            }
            .modal-content {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            .modal-close-btn, .print-btn, .servings-control, .rating-stars span, #addToMealPlanContainer {
                display: none !important;
            }
            h2#detailRecipeTitle {
                font-size: 2em !important;
                text-align: center;
                border-bottom: 2px solid #ccc !important;
                padding-bottom: 10px !important;
                margin-bottom: 20px !important;
                color: #333 !important;
            }
            #recipeDetailModalContent {
                flex-wrap: wrap;
                gap: 20px;
                display: flex;
            }
            #recipeDetailModalContent .detail-section {
                flex: 1 1 48%;
                min-width: auto;
                page-break-inside: avoid;
            }
            #recipeDetailModalContent .detail-section h3 {
                border-bottom: 1px solid #eee !important;
                font-size: 1.3em !important;
                color: #555 !important;
            }
            #recipeDetailModalContent ul,
            #recipeDetailModalContent ol {
                padding-left: 20px !important;
                list-style-position: outside !important;
            }
            #recipeDetailModalContent .ingredient-item.checked {
                text-decoration: none !important;
                color: #333 !important;
            }
            .recipe-detail-meta {
                text-align: left;
                margin-bottom: 20px;
                font-size: 1em;
                color: #333;
            }
            .recipe-detail-meta span {
                background-color: transparent !important;
                color: #333 !important;
                text-decoration: none !important;
                padding: 0 !important;
                margin: 0 5px 0 0 !important;
                font-weight: normal !important;
            }
            .recipe-detail-meta span::after { content: " | "; }
            .recipe-detail-meta span:last-of-type::after { content: ""; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Beckner Recipes</h1>

        <!-- View Toggle Buttons -->
        <div class="view-toggle">
            <button id="recipesViewBtn" class="active">Recipes</button>
            <button id="mealPlanViewBtn">Meal Plan</button>
            <button id="favoritesViewBtn">Favorites</button>
        </div>

        <!-- Top Buttons -->
        <div class="top-buttons">
            <button class="primary-btn" id="openAddRecipeModalBtn">Add New Recipe</button>
        </div>

        <!-- View Recipes Section -->
        <section id="view-recipes-section">
            <h2>Your Saved Recipes</h2>
            <div id="controls">
                <div>
                    <label for="filterCategorySelect">Category:</label>
                    <select id="filterCategorySelect">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div>
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect">
                        <option value="titleAsc">Title (A-Z)</option>
                        <option value="titleDesc">Title (Z-A)</option>
                        <option value="categoryAsc">Category (A-Z)</option>
                        <option value="categoryDesc">Category (Z-A)</option>
                        <option value="ratingDesc">Rating (High to Low)</option>
                        <option value="ratingAsc">Rating (Low to High)</option>
                        <option value="favorites">Favorites First</option>
                    </select>
                    <button id="dark-mode-toggle" aria-label="Toggle dark mode">üåô</button>
                </div>
                <input type="text" id="recipeSearchInput" placeholder="Search by title, ingredients, etc...">
            </div>
            <div id="recipeList">
                <!-- Recipes will be dynamically loaded here -->
            </div>
            <p id="emptyMessage" class="empty-state">No recipes saved yet. Click "Add New Recipe" to get started!</p>
        </section>

        <!-- Meal Planning Section -->
        <section id="meal-plan-section" class="meal-plan-section" style="display: none;">
            <h2>Weekly Meal Plan</h2>
            <div class="meal-plan-controls">
                <select id="mealPlanWeekSelect">
                    <option value="current">This Week</option>
                    <option value="next">Next Week</option>
                </select>
                <button id="clearMealPlanBtn">Clear All</button>
            </div>
            <div class="meal-plan-calendar" id="mealPlanCalendar">
                <!-- Meal plan will be dynamically loaded here -->
            </div>
        </section>

        <!-- Favorites Section -->
        <section id="favorites-section" style="display: none;">
            <h2>Your Favorite Recipes</h2>
            <div id="favoritesList" class="recipe-list">
                <!-- Favorites will be dynamically loaded here -->
            </div>
            <p id="emptyFavoritesMessage" class="empty-state">No favorite recipes yet. Click the heart icon on any recipe to add it to favorites!</p>
        </section>

    </div>

    <!-- Timer Indicator -->
    <div id="timerIndicator" class="timer-indicator"></div>

    <!-- Add Recipe Modal -->
    <div id="addRecipeModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAddRecipeModalBtn">&times;</button>
            <h2 id="addRecipeModalTitle">Add a New Recipe</h2>
            <form id="recipeForm">
                <input type="hidden" id="editingRecipeId" value="">
                
                <div class="form-group">
                    <label for="recipeTitle">Recipe Title:</label>
                    <input type="text" id="recipeTitle" required>
                </div>
                <div class="form-group">
                    <label for="recipeImageFile">Upload Image (Max ~1MB):</label>
                    <input type="file" id="recipeImageFile" accept="image/jpeg, image/png">
                    <p class="image-upload-warning">
                        Images stored in the Cloud. Keep file sizes reasonable (under 1MB).
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="recipeCategory">Category:</label>
                    <div class="category-input-group">
                        <select id="recipeCategory">
                            <!-- Categories will be loaded here by JS -->
                        </select>
                        <input type="text" id="newCategoryName" placeholder="Or add new category...">
                        <button type="button" id="addNewCategoryBtn">Add</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="originalServings">Original Servings:</label>
                    <input type="number" id="originalServings" min="1" value="1" required>
                </div>
                <div class="rating-input-group">
                    <label>Your Rating:</label>
                    <div id="addRecipeRatingStars" class="rating-stars" data-rating="0">
                        <span data-value="1">&#9733;</span><span data-value="2">&#9733;</span><span data-value="3">&#9733;</span><span data-value="4">&#9733;</span><span data-value="5">&#9733;</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ingredients">Ingredients (one item per line):</label>
                    <textarea id="ingredients" rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <label for="instructions">Instructions (one step per line):</label>
                    <textarea id="instructions" rows="8" required></textarea>
                </div>
                <button type="submit" id="saveRecipeBtn">Save Recipe</button>
            </form>
        </div>
    </div>

    <!-- Recipe Detail Modal (Cooking View) -->
    <div id="recipeDetailModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeRecipeDetailModalBtn">&times;</button>
            <h2 id="detailRecipeTitle"></h2>

            <div class="recipe-detail-meta">
                <span id="detailRecipeCategory"></span>
                <span id="detailRecipeRating" class="rating-stars" data-rating="0">
                    <span data-value="1">&#9733;</span><span data-value="2">&#9733;</span><span data-value="3">&#9733;</span><span data-value="4">&#9733;</span><span data-value="5">&#9733;</span>
                </span>
            </div>

            <!-- Meal Plan Controls inside the modal -->
            <div id="addToMealPlanContainer" style="background: var(--meal-plan-bg); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; border: 1px solid var(--meal-plan-border);">
                <label for="addToMealPlanDay" style="display:inline-block; margin-right: 10px;">Add to Meal Plan:</label>
                <select id="addToMealPlanDay" style="width: auto; padding: 5px;">
                    <option value="">-- Select Day --</option>
                    <option value="monday">Monday</option>
                    <option value="tuesday">Tuesday</option>
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday">Friday</option>
                    <option value="saturday">Saturday</option>
                    <option value="sunday">Sunday</option>
                </select>
                <button id="addToMealPlanBtn" style="padding: 6px 15px; font-size: 0.9em; margin-left: 5px;">Add</button>
            </div>

            <div class="servings-control">
                <label>Original Servings: <span id="detailOriginalServings"></span></label>
                <label for="desiredServings">Desired Servings:</label>
                <input type="number" id="desiredServings" min="1" value="1">
            </div>
            <p class="scaling-warning">
                <strong>Scaling Warning:</strong> Ingredient scaling is basic and works best for simple numerical quantities.
            </p>

            <div id="recipeDetailModalContent">
                <!-- Ingredients and instructions will be loaded here -->
            </div>

            <div class="detail-section recipe-notes-section">
                <h3>Your Notes</h3>
                <textarea id="recipeNotes" placeholder="Add your personal notes..."></textarea>
            </div>

            <button class="edit-recipe-btn" id="editRecipeBtn">Edit Recipe</button>
            <button class="print-btn" id="printRecipeBtn">Print Recipe</button>
        </div>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_5czSGHpYR8ZHMuB41mnIf5gL8zvLS6M",
            authDomain: "becknerrecipes.firebaseapp.com",
            projectId: "becknerrecipes",
            storageBucket: "becknerrecipes.firebasestorage.app",
            messagingSenderId: "563764688388",
            appId: "1:563764688388:web:dc5df2823ebcf0e1666751",
            measurementId: "G-SEC7ENVK7Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const recipesCollection = collection(db, 'recipes');

        // --- STATE ---
        let allRecipes = []; 
        let currentRecipeImageData = null;
        let activeRecipeId = null;
        let currentTimer = null;
        let currentView = 'recipes';
        
        // Local Storage for User Specific Settings
        const CATEGORIES_STORAGE_KEY = 'becknerCategories';
        const FAVORITES_STORAGE_KEY = 'becknerFavorites';
        const MEAL_PLAN_STORAGE_KEY = 'becknerMealPlan';
        const DARK_MODE_KEY = 'becknerDarkMode';

        function loadData(key, def) { const j = localStorage.getItem(key); return j ? JSON.parse(j) : def; }
        function saveData(key, d) { localStorage.setItem(key, JSON.stringify(d)); }

        let allCategories = loadData(CATEGORIES_STORAGE_KEY, ['Breakfast', 'Lunch', 'Dinner', 'Dessert', 'Drinks', 'Snacks']);
        allCategories = [...new Set(allCategories)].sort();
        let favorites = loadData(FAVORITES_STORAGE_KEY, []);
        let mealPlan = loadData(MEAL_PLAN_STORAGE_KEY, {});

        // --- DOM ---
        const recipeListDiv = document.getElementById('recipeList');
        const emptyMessage = document.getElementById('emptyMessage');
        const favoritesList = document.getElementById('favoritesList');
        const emptyFavoritesMessage = document.getElementById('emptyFavoritesMessage');
        const mealPlanCalendar = document.getElementById('mealPlanCalendar');
        
        // --- FIRESTORE ---

        async function loadRecipesFromFirestore() {
            try {
                const snapshot = await getDocs(recipesCollection);
                allRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Refresh current view
                if(currentView === 'recipes') renderRecipes();
                else if(currentView === 'favorites') renderFavorites();
                else if(currentView === 'mealPlan') renderMealPlan();
            } catch (error) {
                console.error("Error loading:", error);
            }
        }

        async function saveRecipeToFirestore(recipe) {
            try {
                if (recipe.id) {
                    await updateDoc(doc(db, 'recipes', recipe.id), recipe);
                } else {
                    await addDoc(recipesCollection, recipe);
                }
                await loadRecipesFromFirestore();
                return true;
            } catch (error) {
                console.error("Save failed:", error);
                return false;
            }
        }

        async function deleteRecipeFromFirestore(id) {
            try {
                await deleteDoc(doc(db, 'recipes', id));
                // Clean up local refs
                if(favorites.includes(id)) {
                    favorites = favorites.filter(fid => fid !== id);
                    saveData(FAVORITES_STORAGE_KEY, favorites);
                }
                // Clean meal plan
                Object.keys(mealPlan).forEach(key => {
                    mealPlan[key] = mealPlan[key].filter(mid => mid !== id);
                    if(mealPlan[key].length === 0) delete mealPlan[key];
                });
                saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                
                await loadRecipesFromFirestore();
            } catch (error) {
                console.error("Delete failed:", error);
            }
        }

        // --- RENDERERS ---

        function renderRecipes() {
            recipeListDiv.innerHTML = '';
            let list = [...allRecipes];

            // Search
            const term = document.getElementById('recipeSearchInput').value.toLowerCase();
            if (term) {
                list = list.filter(r => 
                    (r.title && r.title.toLowerCase().includes(term)) ||
                    (r.category && r.category.toLowerCase().includes(term)) ||
                    (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(term)))
                );
            }
            // Filter
            const cat = document.getElementById('filterCategorySelect').value;
            if (cat !== 'all') list = list.filter(r => r.category === cat);
            
            // Sort
            const sortBy = document.getElementById('sortSelect').value;
            if (sortBy === 'titleAsc') list.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            else if (sortBy === 'titleDesc') list.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
            else if (sortBy === 'favorites') list.sort((a, b) => {
                const aFav = favorites.includes(a.id);
                const bFav = favorites.includes(b.id);
                return bFav - aFav;
            });

            if (list.length === 0) {
                emptyMessage.style.display = 'block';
            } else {
                emptyMessage.style.display = 'none';
                list.forEach(recipe => createRecipeCard(recipe, recipeListDiv));
            }
        }

        function renderFavorites() {
            favoritesList.innerHTML = '';
            const list = allRecipes.filter(r => favorites.includes(r.id));
            if(list.length === 0) {
                emptyFavoritesMessage.style.display = 'block';
            } else {
                emptyFavoritesMessage.style.display = 'none';
                list.forEach(recipe => createRecipeCard(recipe, favoritesList));
            }
        }

        function createRecipeCard(recipe, container) {
            const el = document.createElement('div');
            el.className = 'recipe-item';
            el.dataset.id = recipe.id;
            const isFav = favorites.includes(recipe.id);
            
            el.innerHTML = `
                ${recipe.imageData ? `<img src="${recipe.imageData}">` : '<div style="height:180px; background:#ddd; display:flex; align-items:center; justify-content:center;">No Image</div>'}
                <button class="favorite-btn ${isFav ? 'favorited' : ''}">
                    ${isFav ? '‚ù§Ô∏è' : 'ü§ç'}
                </button>
                <h3>${recipe.title}</h3>
                <button class="delete-btn">&times;</button>
            `;

            // Card Clicks
            el.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm(`Delete ${recipe.title}?`)) deleteRecipeFromFirestore(recipe.id);
            });
            el.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(recipe.id, e.target);
            });
            el.addEventListener('click', () => openRecipeDetail(recipe.id));
            
            container.appendChild(el);
        }

        function toggleFavorite(id, btn) {
            if (favorites.includes(id)) {
                favorites = favorites.filter(fid => fid !== id);
                btn.textContent = 'ü§ç';
                btn.classList.remove('favorited');
            } else {
                favorites.push(id);
                btn.textContent = '‚ù§Ô∏è';
                btn.classList.add('favorited');
            }
            saveData(FAVORITES_STORAGE_KEY, favorites);
            if(currentView === 'favorites') renderFavorites();
        }

        function renderMealPlan() {
            mealPlanCalendar.innerHTML = '';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const week = document.getElementById('mealPlanWeekSelect').value;

            days.forEach(day => {
                const dayKey = `${week}-${day.toLowerCase()}`;
                const col = document.createElement('div');
                col.className = 'meal-plan-day';
                col.innerHTML = `<div class="meal-plan-day-header">${day}</div>`;
                
                const mealIds = mealPlan[dayKey] || [];
                mealIds.forEach(id => {
                    const r = allRecipes.find(rec => rec.id === id);
                    if(r) {
                        const item = document.createElement('div');
                        item.className = 'meal-plan-recipe';
                        item.innerHTML = `
                            <span class="meal-plan-recipe-link">${r.title}</span>
                            <button class="remove-meal">&times;</button>
                        `;
                        item.querySelector('.remove-meal').addEventListener('click', () => {
                            mealPlan[dayKey] = mealPlan[dayKey].filter(mid => mid !== id);
                            if(mealPlan[dayKey].length === 0) delete mealPlan[dayKey];
                            saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                            renderMealPlan();
                        });
                        item.querySelector('.meal-plan-recipe-link').addEventListener('click', () => openRecipeDetail(id));
                        col.appendChild(item);
                    }
                });
                mealPlanCalendar.appendChild(col);
            });
        }

        // --- DETAIL VIEW & LOGIC ---

        const desiredServingsInput = document.getElementById('desiredServings');
        
        function openRecipeDetail(id) {
            const recipe = allRecipes.find(r => r.id === id);
            if (!recipe) return;
            activeRecipeId = id;
            
            document.getElementById('detailRecipeTitle').textContent = recipe.title;
            document.getElementById('detailRecipeCategory').textContent = recipe.category;
            document.getElementById('detailOriginalServings').textContent = recipe.originalServings;
            desiredServingsInput.value = recipe.originalServings;
            document.getElementById('recipeNotes').value = recipe.notes || '';
            
            // Render Rating
            renderStars(document.getElementById('detailRecipeRating'), recipe.rating || 0);

            // Initial Ingredient Render
            updateScaledIngredients(recipe);
            
            // Instructions
            const content = document.getElementById('recipeDetailModalContent');
            const ol = document.createElement('ol');
            content.querySelector('.instructions-section')?.remove(); // Cleanup old
            const sec = document.createElement('div');
            sec.className = 'detail-section instructions-section';
            sec.innerHTML = '<h3>Instructions</h3>';
            
            recipe.instructions.forEach(inst => {
                const li = document.createElement('li');
                li.textContent = inst;
                // Simple Timer check
                const match = inst.match(/(\d+)\s*(min|minute)/i);
                if(match) {
                    const btn = document.createElement('button');
                    btn.className = 'timer-btn';
                    btn.textContent = `Start ${match[1]}m Timer`;
                    btn.onclick = () => startTimer(parseInt(match[1]), inst);
                    li.appendChild(btn);
                }
                ol.appendChild(li);
            });
            sec.appendChild(ol);
            content.appendChild(sec);

            document.getElementById('recipeDetailModalOverlay').classList.add('active');
        }

        // Ingredient Scaling Logic
        function updateScaledIngredients(recipe) {
            const content = document.getElementById('recipeDetailModalContent');
            content.querySelector('.ingredients-section')?.remove(); // Cleanup old
            
            const desired = parseFloat(desiredServingsInput.value) || 1;
            const original = parseFloat(recipe.originalServings) || 1;
            const ratio = desired / original;

            const sec = document.createElement('div');
            sec.className = 'detail-section ingredients-section';
            sec.innerHTML = '<h3>Ingredients</h3>';
            const ul = document.createElement('ul');

            recipe.ingredients.forEach(ing => {
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                li.onclick = () => li.classList.toggle('checked');
                
                // Regex for number at start
                const match = ing.match(/^(\d+(\.\d+)?|\d+\/\d+)\s*(.*)/);
                if(match) {
                    let qty = match[1];
                    let rest = match[3];
                    if(qty.includes('/')) {
                        const [n,d] = qty.split('/');
                        qty = parseInt(n)/parseInt(d);
                    } else {
                        qty = parseFloat(qty);
                    }
                    const newQty = (qty * ratio).toFixed(2).replace(/\.00$/, '');
                    li.textContent = `${newQty} ${rest}`;
                } else {
                    li.textContent = ing;
                }
                ul.appendChild(li);
            });
            sec.appendChild(ul);
            content.prepend(sec);
        }

        // Listen for Servings Change
        desiredServingsInput.addEventListener('input', () => {
             const r = allRecipes.find(x => x.id === activeRecipeId);
             if(r) updateScaledIngredients(r);
        });

        // Add to Meal Plan Button (In Modal)
        document.getElementById('addToMealPlanBtn').addEventListener('click', () => {
            const day = document.getElementById('addToMealPlanDay').value;
            if(!day || !activeRecipeId) return;
            const key = `current-${day}`;
            if(!mealPlan[key]) mealPlan[key] = [];
            mealPlan[key].push(activeRecipeId);
            saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
            alert("Added to Meal Plan");
        });

        // Save Notes on Change
        document.getElementById('recipeNotes').addEventListener('change', async (e) => {
             if(activeRecipeId) {
                 await updateDoc(doc(db, 'recipes', activeRecipeId), { notes: e.target.value });
                 const r = allRecipes.find(x => x.id === activeRecipeId);
                 if(r) r.notes = e.target.value;
             }
        });
        
        // Stars Logic
        function renderStars(container, rating) {
            container.dataset.rating = rating;
            Array.from(container.children).forEach(star => {
                star.classList.toggle('filled', parseInt(star.dataset.value) <= rating);
            });
        }
        
        // Setup Stars Click
        [document.getElementById('addRecipeRatingStars'), document.getElementById('detailRecipeRating')].forEach(container => {
             Array.from(container.children).forEach(star => {
                star.addEventListener('click', async () => {
                    const val = parseInt(star.dataset.value);
                    renderStars(container, val);
                    // If in detail view, save immediately
                    if(container.id === 'detailRecipeRating' && activeRecipeId) {
                         await updateDoc(doc(db, 'recipes', activeRecipeId), { rating: val });
                         const r = allRecipes.find(x => x.id === activeRecipeId);
                         if(r) r.rating = val;
                         if(currentView === 'recipes') renderRecipes(); // Refresh list to show sort changes
                    }
                });
             });
        });

        // --- GENERAL EVENT LISTENERS ---

        // View Tabs
        document.getElementById('recipesViewBtn').addEventListener('click', () => switchView('recipes'));
        document.getElementById('mealPlanViewBtn').addEventListener('click', () => switchView('mealPlan'));
        document.getElementById('favoritesViewBtn').addEventListener('click', () => switchView('favorites'));

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${view}ViewBtn`).classList.add('active');
            
            document.getElementById('view-recipes-section').style.display = view === 'recipes' ? 'block' : 'none';
            document.getElementById('meal-plan-section').style.display = view === 'mealPlan' ? 'block' : 'none';
            document.getElementById('favorites-section').style.display = view === 'favorites' ? 'block' : 'none';

            if(view === 'recipes') renderRecipes();
            if(view === 'favorites') renderFavorites();
            if(view === 'mealPlan') renderMealPlan();
        }

        // Add Modal
        document.getElementById('openAddRecipeModalBtn').addEventListener('click', () => {
            document.getElementById('recipeForm').reset();
            currentRecipeImageData = null;
            renderStars(document.getElementById('addRecipeRatingStars'), 0);
            document.getElementById('addRecipeModalOverlay').classList.add('active');
        });
        
        // Close Modals
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal-overlay').classList.remove('active');
            });
        });

        // Edit Recipe
        document.getElementById('editRecipeBtn').addEventListener('click', () => {
            const r = allRecipes.find(x => x.id === activeRecipeId);
            if(!r) return;
            document.getElementById('recipeDetailModalOverlay').classList.remove('active');
            
            const form = document.getElementById('recipeForm');
            document.getElementById('editingRecipeId').value = r.id;
            document.getElementById('recipeTitle').value = r.title;
            document.getElementById('recipeCategory').value = r.category;
            document.getElementById('originalServings').value = r.originalServings;
            document.getElementById('ingredients').value = r.ingredients.join('\n');
            document.getElementById('instructions').value = r.instructions.join('\n');
            renderStars(document.getElementById('addRecipeRatingStars'), r.rating || 0);
            currentRecipeImageData = r.imageData;
            
            document.getElementById('addRecipeModalOverlay').classList.add('active');
        });

        // Save Form
        document.getElementById('recipeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveRecipeBtn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            const data = {
                title: document.getElementById('recipeTitle').value,
                category: document.getElementById('recipeCategory').value,
                originalServings: parseInt(document.getElementById('originalServings').value),
                ingredients: document.getElementById('ingredients').value.split('\n').filter(s=>s.trim()),
                instructions: document.getElementById('instructions').value.split('\n').filter(s=>s.trim()),
                rating: parseInt(document.getElementById('addRecipeRatingStars').dataset.rating || 0),
                imageData: currentRecipeImageData,
                notes: ''
            };
            
            const editId = document.getElementById('editingRecipeId').value;
            if(editId) {
                data.id = editId;
                // Preserve notes/image if not changed
                const old = allRecipes.find(x=>x.id===editId);
                if(old) {
                    data.notes = old.notes;
                    if(!data.imageData) data.imageData = old.imageData;
                }
            }

            if(await saveRecipeToFirestore(data)) {
                document.getElementById('addRecipeModalOverlay').classList.remove('active');
            }
            btn.textContent = 'Save Recipe';
            btn.disabled = false;
        });

        // Image Reader
        document.getElementById('recipeImageFile').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if(file) {
                 const reader = new FileReader();
                 reader.onload = (evt) => currentRecipeImageData = evt.target.result;
                 reader.readAsDataURL(file);
             }
        });
        
        // Search & Filter Listeners
        document.getElementById('recipeSearchInput').addEventListener('input', renderRecipes);
        document.getElementById('filterCategorySelect').addEventListener('change', renderRecipes);
        document.getElementById('sortSelect').addEventListener('change', renderRecipes);

        // Timer
        function startTimer(min, txt) {
            let sec = min * 60;
            const ind = document.getElementById('timerIndicator');
            ind.style.display = 'block';
            
            if(currentTimer) clearInterval(currentTimer);
            
            currentTimer = setInterval(() => {
                sec--;
                const m = Math.floor(sec/60);
                const s = sec%60;
                ind.textContent = `Timer (${txt.substring(0,15)}...): ${m}:${s.toString().padStart(2,'0')}`;
                if(sec <= 0) {
                    clearInterval(currentTimer);
                    ind.style.display = 'none';
                    alert("Timer Done!");
                }
            }, 1000);
        }

        // --- INIT ---
        console.log("App Started");
        
        // Render Categories
        const catSelect = document.getElementById('recipeCategory');
        const filterSelect = document.getElementById('filterCategorySelect');
        function renderCats() {
            catSelect.innerHTML = '';
            allCategories.forEach(c => catSelect.add(new Option(c, c)));
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            allCategories.forEach(c => filterSelect.add(new Option(c, c)));
        }
        renderCats();

        // Add Category
        document.getElementById('addNewCategoryBtn').addEventListener('click', () => {
            const val = document.getElementById('newCategoryName').value.trim();
            if(val && !allCategories.includes(val)) {
                allCategories.push(val);
                saveData(CATEGORIES_STORAGE_KEY, allCategories.sort());
                renderCats();
                catSelect.value = val;
            }
        });

        loadRecipesFromFirestore();

    </script>
</body>
</html>
