<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beckner Recipes</title>
    <style>
        /* --- CSS Custom Properties (Variables) for theming --- */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --header-color: #2c3e50;
            --container-bg: #fff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #fcfcfc;
            --card-shadow: rgba(0, 0, 0, 0.08);
            --input-border: #ccc;
            --input-focus-border: #007bff;
            --button-primary: #007bff;
            --button-primary-hover: #0056b3;
            --button-success: #28a745;
            --button-success-hover: #218838;
            --button-info: #17a2b8;
            --button-info-hover: #138496;
            --button-danger: #dc3545;
            --button-danger-hover: #c82333;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --modal-bg: #fff;
            --modal-shadow: rgba(0, 0, 0, 0.3);
            --warning-bg: #fff3cd;
            --warning-border: #ffeeba;
            --warning-text: #856404;
            --pre-bg: #f8f9fa;
            --pre-border: #e9ecef;
            --category-tag-bg: #e0f7fa;
            --category-tag-text: #007bff;
            --detail-meta-bg: #e9f7ef;
            --detail-meta-text: #28a745;
            --star-color-filled: #ffc107;
            --star-color-empty: #e4e5e9;
            --ingredient-checked-color: #777;
            --favorite-color: #ff4d4d;
            --meal-plan-bg: #f0f8ff;
            --meal-plan-border: #cce5ff;
        }

        body.dark-mode {
            --bg-color: #282c34;
            --text-color: #e0e0e0;
            --header-color: #61dafb;
            --container-bg: #3c414d;
            --border-color: #4a4f5d;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --card-bg: #363a44;
            --card-shadow: rgba(0, 0, 0, 0.2);
            --input-border: #555;
            --input-focus-border: #61dafb;
            --button-primary: #61dafb;
            --button-primary-hover: #21a1f1;
            --button-success: #4CAF50;
            --button-success-hover: #45a049;
            --button-info: #00bcd4;
            --button-info-hover: #0097a7;
            --button-danger: #f44336;
            --button-danger-hover: #da190b;
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --modal-bg: #3c414d;
            --modal-shadow: rgba(0, 0, 0, 0.5);
            --warning-bg: #5a5220;
            --warning-border: #8c7f3e;
            --warning-text: #ffeeba;
            --pre-bg: #4a4f5d;
            --pre-border: #555;
            --category-tag-bg: #1e3a47;
            --category-tag-text: #61dafb;
            --detail-meta-bg: #3a473d;
            --detail-meta-text: #4CAF50;
            --star-color-filled: #ffeb3b;
            --star-color-empty: #777;
            --ingredient-checked-color: #aaa;
            --favorite-color: #ff7f7f;
            --meal-plan-bg: #2a3b4d;
            --meal-plan-border: #3a5670;
        }

        /* --- General Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        h1, h2 {
            color: var(--header-color);
            text-align: center;
            margin-bottom: 25px;
            transition: color 0.3s ease;
        }

        h1 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 40px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select,
        input[type="file"] {
            width: calc(100% - 22px);
            padding: 12px 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        input[type="text"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--input-focus-border);
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .category-input-group {
            display: flex;
            gap: 10px;
        }

        .category-input-group input {
            flex-grow: 1;
        }

        .category-input-group button {
            width: auto;
            padding: 8px 15px;
            margin: 0;
            font-size: 0.9em;
            background-color: var(--button-primary);
        }
        .category-input-group button:hover {
             background-color: var(--button-primary-hover);
        }

        .top-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        button {
            background-color: var(--button-success);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: var(--button-success-hover);
            transform: translateY(-2px);
        }

        .top-buttons .primary-btn {
            background-color: var(--button-primary);
            margin: 0;
        }
        .top-buttons .primary-btn:hover {
            background-color: var(--button-primary-hover);
        }

        .top-buttons #exportJsonBtn,
        .top-buttons #importJsonBtn {
            background-color: var(--button-info);
        }
        .top-buttons #exportJsonBtn:hover,
        .top-buttons #importJsonBtn:hover {
            background-color: var(--button-info-hover);
        }
        .top-buttons #clearAndImportJsonBtn {
            background-color: var(--button-danger);
        }
        .top-buttons #clearAndImportJsonBtn:hover {
            background-color: var(--button-danger-hover);
        }

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        #controls > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #controls label {
            margin-bottom: 0;
            font-weight: normal;
        }

        #recipeSearchInput {
            flex-grow: 1;
            min-width: 150px;
        }

        #sortSelect, #filterCategorySelect {
            width: 180px;
            padding: 8px;
            font-size: 0.95em;
        }

        #dark-mode-toggle {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            margin-left: 20px;
            transition: color 0.3s ease;
        }
        #dark-mode-toggle:hover {
            color: var(--header-color);
            transform: scale(1.1);
        }

        #recipeList {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .recipe-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--card-shadow);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .recipe-item:hover {
            transform: translateY(-5px);
        }

        .recipe-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
            display: block;
        }

        .recipe-item h3 {
            color: var(--button-primary);
            margin: 15px 10px;
            font-size: 1.4em;
            text-align: center;
            line-height: 1.3;
            min-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            transition: color 0.3s ease;
        }

        .recipe-item .delete-btn {
            background-color: var(--button-danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8em;
            position: absolute;
            top: 8px;
            right: 8px;
            transition: background-color 0.2s ease;
            z-index: 10;
        }

        .recipe-item .delete-btn:hover {
            background-color: var(--button-danger-hover);
        }

        .recipe-item .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            color: var(--star-color-empty);
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .recipe-item .favorite-btn.favorited {
            color: var(--favorite-color);
        }

        .recipe-item .favorite-btn:hover {
            transform: scale(1.2);
        }

        .empty-state {
            text-align: center;
            font-style: italic;
            color: var(--text-color);
            margin-top: 30px;
            font-size: 1.1em;
        }

        #importFileInput {
            display: none;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--modal-shadow);
            width: 90%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 2em;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: var(--button-danger);
        }

        /* Recipe Detail View (Cooking View) Layout */
        #recipeDetailModalContent {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        #recipeDetailModalContent .detail-section {
            flex: 1;
            min-width: 380px;
            font-size: 1.1em;
        }

        #recipeDetailModalContent h3 {
            font-size: 1.5em;
            color: var(--button-primary);
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        #recipeDetailModalContent ul,
        #recipeDetailModalContent ol {
            padding-left: 25px;
            margin-top: 0;
            list-style-position: inside;
        }

        #recipeDetailModalContent li {
            margin-bottom: 10px;
        }

        /* Styling for ingredient checklist */
        #recipeDetailModalContent .ingredient-item {
            cursor: pointer;
            user-select: none;
            list-style-type: disc;
        }

        #recipeDetailModalContent .ingredient-item.checked {
            text-decoration: line-through;
            color: var(--ingredient-checked-color);
        }

        /* Styling for instruction timers */
        #recipeDetailModalContent .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        #recipeDetailModalContent .instruction-item .timer-btn {
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 5px;
            background-color: var(--button-primary);
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        #recipeDetailModalContent .instruction-item .timer-btn:hover {
            background-color: var(--button-primary-hover);
        }
        /* Timer indicator */
        .timer-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-danger);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .recipe-detail-meta {
            font-size: 0.95em;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-color);
        }
        .recipe-detail-meta span {
            display: inline-block;
            background-color: var(--detail-meta-bg);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: bold;
            color: var(--detail-meta-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .image-upload-warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        /* Rating Stars */
        .rating-stars {
            display: inline-block;
            font-size: 1.5em;
            color: var(--star-color-empty);
            letter-spacing: -2px;
        }
        .rating-stars span {
            cursor: pointer;
            transition: color 0.2s;
            display: inline-block;
            padding: 0 2px;
        }
        .rating-stars span.filled {
            color: var(--star-color-filled);
        }
        .rating-input-group .rating-stars {
            margin-left: 10px;
            font-size: 2em;
            vertical-align: middle;
            color: var(--star-color-empty);
        }
        .rating-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .rating-input-group label {
            margin-bottom: 0;
        }

        /* Servings Scaling */
        .servings-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .servings-control label {
            margin: 0;
            white-space: nowrap;
        }
        .servings-control input[type="number"] {
            width: 80px;
            text-align: center;
            padding: 8px 5px;
            height: auto;
        }
        .scaling-warning {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        /* Recipe Notes */
        #recipeNotes {
            width: 100%;
            min-height: 150px;
            box-sizing: border-box;
        }

        /* Print Button */
        .print-btn {
            background-color: var(--button-info);
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            border-radius: 5px;
        }
        .print-btn:hover {
            background-color: var(--button-info-hover);
        }

        /* Meal Planning Styles */
        .meal-plan-section {
            margin-top: 40px;
            padding: 20px;
            background-color: var(--meal-plan-bg);
            border: 1px solid var(--meal-plan-border);
            border-radius: 12px;
        }

        .meal-plan-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .meal-plan-controls select,
        .meal-plan-controls input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        .meal-plan-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .meal-plan-day {
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            min-height: 150px;
        }

        .meal-plan-day-header {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .meal-plan-recipe {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            cursor: move;
            font-size: 0.9em;
            position: relative;
        }
        
        .meal-plan-recipe-link {
            color: var(--button-primary);
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        .meal-plan-recipe-link:hover {
            text-decoration: underline;
        }

        .meal-plan-recipe .remove-meal {
            position: absolute;
            top: 4px;
            right: 4px;
            background: none;
            border: none;
            color: var(--button-danger);
            cursor: pointer;
            font-size: 1.2em;
        }

        .meal-plan-recipe .remove-meal:hover {
            color: var(--button-danger-hover);
        }

        /* Edit Button in Detail Modal */
        .edit-recipe-btn {
            background-color: var(--button-info);
            margin-right: 10px;
        }

        .edit-recipe-btn:hover {
            background-color: var(--button-info-hover);
        }

        /* View Toggle Buttons */
        .view-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .view-toggle button {
            padding: 10px 20px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .view-toggle button.active {
            background-color: var(--button-primary);
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container, .modal-content {
                padding: 15px;
                margin: 10px auto;
            }
            h1 {
                font-size: 2em;
            }
            h2 {
                font-size: 1.5em;
            }
            .recipe-item h3 {
                font-size: 1.2em;
            }
            #recipeDetailModalContent .detail-section {
                min-width: 100%;
            }
            .category-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            .category-input-group button {
                width: 100%;
            }
            .top-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .top-buttons button {
                width: 100%;
            }
            #sortSelect, #filterCategorySelect, #recipeSearchInput {
                width: 100%;
            }
            #dark-mode-toggle {
                margin-left: 0;
            }
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            #controls > div {
                justify-content: space-between;
                width: 100%;
                flex-wrap: wrap;
            }
            #controls > div:last-child {
                justify-content: space-between;
                width: 100%;
            }
            .servings-control {
                flex-direction: column;
            }
            .meal-plan-calendar {
                grid-template-columns: repeat(1, 1fr);
            }
            .meal-plan-controls {
                flex-direction: column;
            }
        }

        /* --- Print Styles --- */
        @media print {
            body > *:not(.modal-overlay.active) {
                display: none !important;
            }
            .modal-overlay.active {
                position: static;
                background-color: transparent !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 100%;
                height: auto;
                overflow: visible;
                margin: 0;
                padding: 0;
            }
            .modal-content {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            .modal-close-btn, .print-btn, .servings-control, .rating-stars span, #addToMealPlanContainer {
                display: none !important;
            }
            h2#detailRecipeTitle {
                font-size: 2em !important;
                text-align: center;
                border-bottom: 2px solid #ccc !important;
                padding-bottom: 10px !important;
                margin-bottom: 20px !important;
                color: #333 !important;
            }
            #recipeDetailModalContent {
                flex-wrap: wrap;
                gap: 20px;
                display: flex;
            }
            #recipeDetailModalContent .detail-section {
                flex: 1 1 48%;
                min-width: auto;
                page-break-inside: avoid;
            }
            #recipeDetailModalContent .detail-section h3 {
                border-bottom: 1px solid #eee !important;
                font-size: 1.3em !important;
                color: #555 !important;
            }
            #recipeDetailModalContent ul,
            #recipeDetailModalContent ol {
                padding-left: 20px !important;
                list-style-position: outside !important;
            }
            #recipeDetailModalContent .ingredient-item.checked {
                text-decoration: none !important;
                color: #333 !important;
            }
            .recipe-detail-meta {
                text-align: left;
                margin-bottom: 20px;
                font-size: 1em;
                color: #333;
            }
            .recipe-detail-meta span {
                background-color: transparent !important;
                color: #333 !important;
                text-decoration: none !important;
                padding: 0 !important;
                margin: 0 5px 0 0 !important;
                font-weight: normal !important;
            }
            .recipe-detail-meta span::after { content: " | "; }
            .recipe-detail-meta span:last-of-type::after { content: ""; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Beckner Recipes</h1>

        <!-- View Toggle Buttons -->
        <div class="view-toggle">
            <button id="recipesViewBtn" class="active">Recipes</button>
            <button id="mealPlanViewBtn">Meal Plan</button>
            <button id="favoritesViewBtn">Favorites</button>
        </div>

        <!-- Top Buttons -->
        <div class="top-buttons">
            <button id="exportJsonBtn">Export All Recipes (JSON)</button>
            <button id="importJsonBtn">Merge with JSON</button>
            <button id="clearAndImportJsonBtn">Clear All & Import JSON</button>
            <input type="file" id="importFileInput" accept=".json">
            <button class="primary-btn" id="openAddRecipeModalBtn">Add New Recipe</button>
        </div>

        <!-- View Recipes Section -->
        <section id="view-recipes-section">
            <h2>Your Saved Recipes</h2>
            <div id="controls">
                <div>
                    <label for="filterCategorySelect">Category:</label>
                    <select id="filterCategorySelect">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div>
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect">
                        <option value="titleAsc">Title (A-Z)</option>
                        <option value="titleDesc">Title (Z-A)</option>
                        <option value="categoryAsc">Category (A-Z)</option>
                        <option value="categoryDesc">Category (Z-A)</option>
                        <option value="ratingDesc">Rating (High to Low)</option>
                        <option value="ratingAsc">Rating (Low to High)</option>
                        <option value="favorites">Favorites First</option>
                    </select>
                    <button id="dark-mode-toggle" aria-label="Toggle dark mode">ðŸŒ™</button>
                </div>
                <input type="text" id="recipeSearchInput" placeholder="Search by title, ingredients, etc...">
            </div>
            <div id="recipeList">
                <!-- Recipes will be dynamically loaded here -->
            </div>
            <p id="emptyMessage" class="empty-state">No recipes saved yet. Click "Add New Recipe" to get started!</p>
        </section>

        <!-- Meal Planning Section -->
        <section id="meal-plan-section" class="meal-plan-section" style="display: none;">
            <h2>Weekly Meal Plan</h2>
            <div class="meal-plan-controls">
                <select id="mealPlanWeekSelect">
                    <option value="current">This Week</option>
                    <option value="next">Next Week</option>
                </select>
                <button id="clearMealPlanBtn">Clear All</button>
            </div>
            <div class="meal-plan-calendar" id="mealPlanCalendar">
                <!-- Meal plan will be dynamically loaded here -->
            </div>
        </section>

        <!-- Favorites Section -->
        <section id="favorites-section" style="display: none;">
            <h2>Your Favorite Recipes</h2>
            <div id="favoritesList" class="recipe-list">
                <!-- Favorites will be dynamically loaded here -->
            </div>
            <p id="emptyFavoritesMessage" class="empty-state">No favorite recipes yet. Click the heart icon on any recipe to add it to favorites!</p>
        </section>

    </div>

    <!-- Timer Indicator -->
    <div id="timerIndicator" class="timer-indicator"></div>

    <!-- Add Recipe Modal -->
    <div id="addRecipeModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAddRecipeModalBtn">&times;</button>
            <h2 id="addRecipeModalTitle">Add a New Recipe</h2>
            <form id="recipeForm">
                <input type="hidden" id="editingRecipeId" value="">
                
                <div class="form-group">
                    <label for="recipeTitle">Recipe Title:</label>
                    <input type="text" id="recipeTitle" required>
                </div>
                <div class="form-group">
                    <label for="recipeImageFile">Upload Image (JPG/PNG - Max ~200KB for localStorage):</label>
                    <input type="file" id="recipeImageFile" accept="image/jpeg, image/png">
                    <p class="image-upload-warning">
                        <strong>Warning:</strong> Images are stored directly in your browser's local storage. Large images can quickly fill up storage space and cause issues.
                        Keep file sizes small (e.g., under 200KB).
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="recipeCategory">Category:</label>
                    <div class="category-input-group">
                        <select id="recipeCategory">
                            <!-- Categories will be loaded here by JS -->
                        </select>
                        <input type="text" id="newCategoryName" placeholder="Or add new category...">
                        <button type="button" id="addNewCategoryBtn">Add</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="originalServings">Original Servings:</label>
                    <input type="number" id="originalServings" min="1" value="1" required>
                </div>
                <div class="rating-input-group">
                    <label>Your Rating:</label>
                    <div id="addRecipeRatingStars" class="rating-stars" data-rating="0">
                        <span data-value="1">&#9733;</span><span data-value="2">&#9733;</span><span data-value="3">&#9733;</span><span data-value="4">&#9733;</span><span data-value="5">&#9733;</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ingredients">Ingredients (one item per line for best scaling results):</label>
                    <textarea id="ingredients" rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <label for="instructions">Instructions (one step per line):</label>
                    <textarea id="instructions" rows="8" required></textarea>
                </div>
                <button type="submit" id="saveRecipeBtn">Save Recipe</button>
            </form>
        </div>
    </div>

    <!-- Recipe Detail Modal (Cooking View) -->
    <div id="recipeDetailModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeRecipeDetailModalBtn">&times;</button>
            <h2 id="detailRecipeTitle"></h2>

            <div class="recipe-detail-meta">
                <span id="detailRecipeCategory"></span>
                <span id="detailRecipeRating" class="rating-stars" data-rating="0">
                    <span data-value="1">&#9733;</span><span data-value="2">&#9733;</span><span data-value="3">&#9733;</span><span data-value="4">&#9733;</span><span data-value="5">&#9733;</span>
                </span>
            </div>

            <!-- Meal Plan Controls inside the modal -->
            <div id="addToMealPlanContainer" style="background: var(--meal-plan-bg); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; border: 1px solid var(--meal-plan-border);">
                <label for="addToMealPlanDay" style="display:inline-block; margin-right: 10px;">Add to Meal Plan:</label>
                <select id="addToMealPlanDay" style="width: auto; padding: 5px;">
                    <option value="">-- Select Day --</option>
                    <option value="monday">Monday</option>
                    <option value="tuesday">Tuesday</option>
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday">Friday</option>
                    <option value="saturday">Saturday</option>
                    <option value="sunday">Sunday</option>
                </select>
                <button id="addToMealPlanBtn" style="padding: 6px 15px; font-size: 0.9em; margin-left: 5px;">Add</button>
            </div>

            <div class="servings-control">
                <label>Original Servings: <span id="detailOriginalServings"></span></label>
                <label for="desiredServings">Desired Servings:</label>
                <input type="number" id="desiredServings" min="1" value="1">
            </div>
            <p class="scaling-warning">
                <strong>Scaling Warning:</strong> Ingredient scaling is basic and works best for simple numerical quantities (e.g., "2 cups"). It may not accurately scale complex descriptions.
            </p>

            <div id="recipeDetailModalContent">
                <!-- Ingredients and instructions will be loaded here -->
            </div>

            <div class="detail-section recipe-notes-section">
                <h3>Your Notes</h3>
                <textarea id="recipeNotes" placeholder="Add your personal notes, tips, or modifications here..."></textarea>
            </div>

            <button class="edit-recipe-btn" id="editRecipeBtn">Edit Recipe</button>
            <button class="print-btn" id="printRecipeBtn">Print Recipe</button>
        </div>
    </div>

    <script>
        // JavaScript for Beckner Recipes
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const recipeForm = document.getElementById('recipeForm');
            const recipeListDiv = document.getElementById('recipeList');
            const emptyMessage = document.getElementById('emptyMessage');
            const recipeCategorySelect = document.getElementById('recipeCategory');
            const filterCategorySelect = document.getElementById('filterCategorySelect');
            const newCategoryNameInput = document.getElementById('newCategoryName');
            const addNewCategoryBtn = document.getElementById('addNewCategoryBtn');
            const sortSelect = document.getElementById('sortSelect');
            const recipeSearchInput = document.getElementById('recipeSearchInput');
            const exportJsonBtn = document.getElementById('exportJsonBtn');
            const importJsonBtn = document.getElementById('importJsonBtn');
            const clearAndImportJsonBtn = document.getElementById('clearAndImportJsonBtn');
            const importFileInput = document.getElementById('importFileInput');
            const recipeImageFile = document.getElementById('recipeImageFile');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const addRecipeRatingStars = document.getElementById('addRecipeRatingStars');
            const originalServingsInput = document.getElementById('originalServings');
            const editingRecipeIdInput = document.getElementById('editingRecipeId');
            const addRecipeModalTitle = document.getElementById('addRecipeModalTitle');
            const saveRecipeBtn = document.getElementById('saveRecipeBtn');

            // View Toggle Elements
            const recipesViewBtn = document.getElementById('recipesViewBtn');
            const mealPlanViewBtn = document.getElementById('mealPlanViewBtn');
            const favoritesViewBtn = document.getElementById('favoritesViewBtn');
            const viewRecipesSection = document.getElementById('view-recipes-section');
            const mealPlanSection = document.getElementById('meal-plan-section');
            const favoritesSection = document.getElementById('favorites-section');
            const favoritesList = document.getElementById('favoritesList');
            const emptyFavoritesMessage = document.getElementById('emptyFavoritesMessage');

            // Meal Plan Elements
            const mealPlanWeekSelect = document.getElementById('mealPlanWeekSelect');
            const clearMealPlanBtn = document.getElementById('clearMealPlanBtn');
            const mealPlanCalendar = document.getElementById('mealPlanCalendar');
            const addToMealPlanBtn = document.getElementById('addToMealPlanBtn');
            const addToMealPlanDay = document.getElementById('addToMealPlanDay');

            // Modal Elements
            const addRecipeModalOverlay = document.getElementById('addRecipeModalOverlay');
            const openAddRecipeModalBtn = document.getElementById('openAddRecipeModalBtn');
            const closeAddRecipeModalBtn = document.getElementById('closeAddRecipeModalBtn');

            const recipeDetailModalOverlay = document.getElementById('recipeDetailModalOverlay');
            const closeRecipeDetailModalBtn = document.getElementById('closeRecipeDetailModalBtn');
            const detailRecipeTitle = document.getElementById('detailRecipeTitle');
            const detailRecipeCategory = document.getElementById('detailRecipeCategory');
            const detailRecipeRating = document.getElementById('detailRecipeRating');
            const detailOriginalServings = document.getElementById('detailOriginalServings');
            const desiredServingsInput = document.getElementById('desiredServings');
            const recipeDetailModalContent = document.getElementById('recipeDetailModalContent');
            const recipeNotesTextarea = document.getElementById('recipeNotes');
            const printRecipeBtn = document.getElementById('printRecipeBtn');
            const editRecipeBtn = document.getElementById('editRecipeBtn');
            const timerIndicator = document.getElementById('timerIndicator');

            // State Variables
            let currentRecipeImageData = null;
            let activeRecipeId = null;
            let currentTimer = null;
            let currentView = 'recipes';

            // --- Local Storage Keys ---
            const RECIPES_STORAGE_KEY = 'becknerRecipes';
            const CATEGORIES_STORAGE_KEY = 'becknerCategories';
            const FAVORITES_STORAGE_KEY = 'becknerFavorites';
            const MEAL_PLAN_STORAGE_KEY = 'becknerMealPlan';
            const DARK_MODE_KEY = 'becknerDarkMode';

            // --- Data Management ---
            function loadData(key, defaultValue) {
                const json = localStorage.getItem(key);
                return json ? JSON.parse(json) : defaultValue;
            }

            function saveData(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            let allRecipes = loadData(RECIPES_STORAGE_KEY, []);
            let allCategories = loadData(CATEGORIES_STORAGE_KEY, ['Breakfast', 'Lunch', 'Dinner', 'Dessert', 'Drinks', 'Snacks']);
            allCategories = [...new Set(allCategories)].sort();
            let favorites = loadData(FAVORITES_STORAGE_KEY, []);
            let mealPlan = loadData(MEAL_PLAN_STORAGE_KEY, {});
            let currentFilterCategory = 'all';
            let currentSearchTerm = '';

            // --- Dark Mode ---
            function enableDarkMode() {
                document.body.classList.add('dark-mode');
                darkModeToggle.textContent = 'â˜€ï¸';
                saveData(DARK_MODE_KEY, true);
            }

            function disableDarkMode() {
                document.body.classList.remove('dark-mode');
                darkModeToggle.textContent = 'ðŸŒ™';
                saveData(DARK_MODE_KEY, false);
            }

            function toggleDarkMode() {
                if (document.body.classList.contains('dark-mode')) {
                    disableDarkMode();
                } else {
                    enableDarkMode();
                }
            }

            darkModeToggle.addEventListener('click', toggleDarkMode);
            if (loadData(DARK_MODE_KEY, false)) {
                enableDarkMode();
            } else {
                disableDarkMode();
            }

            // --- Modal Functions ---
            function openModal(modalOverlay) {
                modalOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeModal(modalOverlay) {
                modalOverlay.classList.remove('active');
                document.body.style.overflow = '';
                if (currentTimer) {
                    clearInterval(currentTimer);
                    timerIndicator.style.display = 'none';
                    currentTimer = null;
                }
            }

            // --- View Management ---
            function setActiveView(view) {
                currentView = view;
                
                // Update button states
                recipesViewBtn.classList.toggle('active', view === 'recipes');
                mealPlanViewBtn.classList.toggle('active', view === 'mealPlan');
                favoritesViewBtn.classList.toggle('active', view === 'favorites');
                
                // Show/hide sections
                viewRecipesSection.style.display = view === 'recipes' ? 'block' : 'none';
                mealPlanSection.style.display = view === 'mealPlan' ? 'block' : 'none';
                favoritesSection.style.display = view === 'favorites' ? 'block' : 'none';
                
                // Refresh the current view
                if (view === 'recipes') {
                    renderRecipes();
                } else if (view === 'mealPlan') {
                    renderMealPlan();
                } else if (view === 'favorites') {
                    renderFavorites();
                }
            }

            // --- Rating Stars ---
            function renderStars(container, rating) {
                container.dataset.rating = rating;
                Array.from(container.children).forEach(star => {
                    star.classList.toggle('filled', parseInt(star.dataset.value) <= rating);
                });
            }

            function setupStarRating(container) {
                Array.from(container.children).forEach(star => {
                    star.addEventListener('click', () => {
                        const newRating = parseInt(star.dataset.value);
                        renderStars(container, newRating);
                        if (container === detailRecipeRating && activeRecipeId) {
                            const recipe = allRecipes.find(r => r.id === activeRecipeId);
                            if (recipe) {
                                recipe.rating = newRating;
                                saveData(RECIPES_STORAGE_KEY, allRecipes);
                                renderRecipes();
                            }
                        }
                    });
                    star.addEventListener('mouseover', () => {
                         Array.from(container.children).forEach(s => {
                            s.classList.toggle('filled', parseInt(s.dataset.value) <= parseInt(star.dataset.value));
                        });
                    });
                    star.addEventListener('mouseout', () => {
                        renderStars(container, parseInt(container.dataset.rating));
                    });
                });
            }

            setupStarRating(addRecipeRatingStars);
            setupStarRating(detailRecipeRating);

            // --- Category Management ---
            function renderCategoryDropdowns() {
                recipeCategorySelect.innerHTML = '';
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    recipeCategorySelect.appendChild(option);
                });
                if (allCategories.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '-- No Categories --';
                    option.disabled = true;
                    option.selected = true;
                    recipeCategorySelect.appendChild(option);
                }

                filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterCategorySelect.appendChild(option);
                });
                filterCategorySelect.value = currentFilterCategory;
            }

            addNewCategoryBtn.addEventListener('click', () => {
                const newCat = newCategoryNameInput.value.trim();
                if (newCat && !allCategories.includes(newCat)) {
                    allCategories.push(newCat);
                    allCategories.sort();
                    saveData(CATEGORIES_STORAGE_KEY, allCategories);
                    renderCategoryDropdowns();
                    recipeCategorySelect.value = newCat;
                    newCategoryNameInput.value = '';
                } else if (newCat) {
                    alert(`Category "${newCat}" already exists.`);
                    newCategoryNameInput.value = '';
                }
            });

            // --- Recipe Rendering & Sorting/Filtering/Searching ---
            function renderRecipes() {
                recipeListDiv.innerHTML = '';
                let recipesToRender = [...allRecipes];

                // Apply Search
                if (currentSearchTerm) {
                    const searchLower = currentSearchTerm.toLowerCase();
                    recipesToRender = recipesToRender.filter(recipe =>
                        (recipe.title && recipe.title.toLowerCase().includes(searchLower)) ||
                        (recipe.category && recipe.category.toLowerCase().includes(searchLower)) ||
                        (recipe.ingredients && recipe.ingredients.some(ing => ing.toLowerCase().includes(searchLower))) ||
                        (recipe.instructions && recipe.instructions.some(inst => inst.toLowerCase().includes(searchLower)))
                    );
                }

                // Apply Filtering
                if (currentFilterCategory !== 'all') {
                    recipesToRender = recipesToRender.filter(recipe => recipe.category === currentFilterCategory);
                }

                // Apply Sorting
                const sortBy = sortSelect.value;
                if (sortBy === 'titleAsc') {
                    recipesToRender.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                } else if (sortBy === 'titleDesc') {
                    recipesToRender.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
                } else if (sortBy === 'categoryAsc') {
                    recipesToRender.sort((a, b) => ((a.category || '').localeCompare(b.category || '') || (a.title || '').localeCompare(b.title || '')));
                } else if (sortBy === 'categoryDesc') {
                    recipesToRender.sort((a, b) => ((b.category || '').localeCompare(a.category || '') || (b.title || '').localeCompare(a.title || '')));
                } else if (sortBy === 'ratingDesc') {
                    recipesToRender.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                } else if (sortBy === 'ratingAsc') {
                    recipesToRender.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                } else if (sortBy === 'favorites') {
                    recipesToRender.sort((a, b) => {
                        const aFav = favorites.includes(a.id);
                        const bFav = favorites.includes(b.id);
                        return bFav - aFav || (a.title || '').localeCompare(b.title || '');
                    });
                }

                if (recipesToRender.length === 0) {
                    emptyMessage.style.display = 'block';
                    return;
                } else {
                    emptyMessage.style.display = 'none';
                }

                recipesToRender.forEach((recipe) => {
                    const recipeItem = document.createElement('div');
                    recipeItem.classList.add('recipe-item');
                    recipeItem.dataset.recipeId = recipe.id;

                    const isFavorited = favorites.includes(recipe.id);
                    
                    recipeItem.innerHTML = `
                        ${recipe.imageData ? `<img src="${recipe.imageData}" alt="${recipe.title}">` : '<img src="https://via.placeholder.com/300x180/cccccc/000000?text=No+Image" alt="No Image">'}
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-recipe-id="${recipe.id}">${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}</button>
                        <h3>${recipe.title}</h3>
                        <button class="delete-btn" data-recipe-id="${recipe.id}">&times;</button>
                    `;
                    recipeListDiv.appendChild(recipeItem);
                });

                // Add event listeners
                document.querySelectorAll('.recipe-item').forEach(item => {
                    item.addEventListener('click', (event) => {
                        if (event.target.classList.contains('delete-btn')) {
                            event.stopPropagation();
                            deleteRecipe(event);
                        } else if (event.target.classList.contains('favorite-btn')) {
                            event.stopPropagation();
                            toggleFavorite(event);
                        } else {
                            openRecipeDetail(parseInt(item.dataset.recipeId));
                        }
                    });
                });
            }

            // --- Favorites Management ---
            function toggleFavorite(event) {
                const recipeId = parseInt(event.target.dataset.recipeId);
                const index = favorites.indexOf(recipeId);
                
                if (index > -1) {
                    // Remove from favorites
                    favorites.splice(index, 1);
                    event.target.textContent = 'ðŸ¤';
                    event.target.classList.remove('favorited');
                } else {
                    // Add to favorites
                    favorites.push(recipeId);
                    event.target.textContent = 'â¤ï¸';
                    event.target.classList.add('favorited');
                }
                
                saveData(FAVORITES_STORAGE_KEY, favorites);
                
                // If we're in favorites view, refresh it
                if (currentView === 'favorites') {
                    renderFavorites();
                }
            }

            function renderFavorites() {
                favoritesList.innerHTML = '';
                const favoriteRecipes = allRecipes.filter(recipe => favorites.includes(recipe.id));
                
                if (favoriteRecipes.length === 0) {
                    emptyFavoritesMessage.style.display = 'block';
                    return;
                } else {
                    emptyFavoritesMessage.style.display = 'none';
                }

                favoriteRecipes.forEach((recipe) => {
                    const recipeItem = document.createElement('div');
                    recipeItem.classList.add('recipe-item');
                    recipeItem.dataset.recipeId = recipe.id;
                    
                    recipeItem.innerHTML = `
                        ${recipe.imageData ? `<img src="${recipe.imageData}" alt="${recipe.title}">` : '<img src="https://via.placeholder.com/300x180/cccccc/000000?text=No+Image" alt="No Image">'}
                        <button class="favorite-btn favorited" data-recipe-id="${recipe.id}">â¤ï¸</button>
                        <h3>${recipe.title}</h3>
                        <button class="delete-btn" data-recipe-id="${recipe.id}">&times;</button>
                    `;
                    favoritesList.appendChild(recipeItem);
                });

                // Add event listeners for favorites view
                document.querySelectorAll('#favoritesList .recipe-item').forEach(item => {
                    item.addEventListener('click', (event) => {
                        if (event.target.classList.contains('delete-btn')) {
                            event.stopPropagation();
                            deleteRecipe(event);
                        } else if (event.target.classList.contains('favorite-btn')) {
                            event.stopPropagation();
                            toggleFavorite(event);
                        } else {
                            openRecipeDetail(parseInt(item.dataset.recipeId));
                        }
                    });
                });
            }

            // --- Meal Planning ---
            function renderMealPlan() {
                mealPlanCalendar.innerHTML = '';
                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const currentWeek = mealPlanWeekSelect.value;
                
                daysOfWeek.forEach(day => {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('meal-plan-day');
                    dayDiv.dataset.day = day.toLowerCase();
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.classList.add('meal-plan-day-header');
                    dayHeader.textContent = day;
                    dayDiv.appendChild(dayHeader);
                    
                    const dayRecipes = mealPlan[`${currentWeek}-${day.toLowerCase()}`] || [];
                    const recipesContainer = document.createElement('div');
                    recipesContainer.classList.add('meal-plan-recipes');
                    
                    dayRecipes.forEach(recipeId => {
                        const recipe = allRecipes.find(r => r.id === recipeId);
                        if (recipe) {
                            const recipeDiv = document.createElement('div');
                            recipeDiv.classList.add('meal-plan-recipe');
                            recipeDiv.draggable = true;
                            recipeDiv.dataset.recipeId = recipeId;
                            
                            recipeDiv.innerHTML = `
                                <span class="meal-plan-recipe-link" data-recipe-id="${recipeId}">${recipe.title}</span>
                                <button class="remove-meal" data-recipe-id="${recipeId}">&times;</button>
                            `;
                            
                            // Add click listener to the title
                            const titleSpan = recipeDiv.querySelector('.meal-plan-recipe-link');
                            titleSpan.addEventListener('click', (e) => {
                                e.stopPropagation(); // prevent drag start if needed
                                openRecipeDetail(recipeId);
                            });

                            recipesContainer.appendChild(recipeDiv);
                        }
                    });
                    
                    dayDiv.appendChild(recipesContainer);
                    mealPlanCalendar.appendChild(dayDiv);
                });

                // Add drag and drop functionality
                setupDragAndDrop();
                
                // Add event listeners for remove buttons
                document.querySelectorAll('.remove-meal').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        removeFromMealPlan(event);
                    });
                });
            }

            function setupDragAndDrop() {
                const recipeItems = document.querySelectorAll('.recipe-item');
                const mealPlanDays = document.querySelectorAll('.meal-plan-day');
                
                // Make recipe items draggable
                recipeItems.forEach(item => {
                    item.draggable = true;
                    item.addEventListener('dragstart', (event) => {
                        event.dataTransfer.setData('text/plain', event.target.dataset.recipeId);
                    });
                });
                
                // Setup drop zones
                mealPlanDays.forEach(day => {
                    day.addEventListener('dragover', (event) => {
                        event.preventDefault();
                        day.classList.add('drag-over');
                    });
                    
                    day.addEventListener('dragleave', () => {
                        day.classList.remove('drag-over');
                    });
                    
                    day.addEventListener('drop', (event) => {
                        event.preventDefault();
                        day.classList.remove('drag-over');
                        
                        const recipeId = parseInt(event.dataTransfer.getData('text/plain'));
                        const dayName = day.dataset.day;
                        const currentWeek = mealPlanWeekSelect.value;
                        const key = `${currentWeek}-${dayName}`;
                        
                        if (!mealPlan[key]) {
                            mealPlan[key] = [];
                        }
                        
                        if (!mealPlan[key].includes(recipeId)) {
                            mealPlan[key].push(recipeId);
                            saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                            renderMealPlan();
                        }
                    });
                });
            }

            function removeFromMealPlan(event) {
                const recipeId = parseInt(event.target.dataset.recipeId);
                const currentWeek = mealPlanWeekSelect.value;
                
                for (const key in mealPlan) {
                    if (key.startsWith(currentWeek)) {
                        const index = mealPlan[key].indexOf(recipeId);
                        if (index > -1) {
                            mealPlan[key].splice(index, 1);
                            if (mealPlan[key].length === 0) {
                                delete mealPlan[key];
                            }
                        }
                    }
                }
                saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                renderMealPlan(); // Re-render after modifying meal plan
            }

            clearMealPlanBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the entire meal plan for this week?')) {
                    const currentWeek = mealPlanWeekSelect.value;
                    for (const key in mealPlan) {
                        if (key.startsWith(currentWeek)) {
                            delete mealPlan[key];
                        }
                    }
                    saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                    renderMealPlan();
                }
            });

            mealPlanWeekSelect.addEventListener('change', renderMealPlan);

            // Add to meal plan directly from modal logic
            addToMealPlanBtn.addEventListener('click', () => {
                const day = addToMealPlanDay.value;
                if (!day) {
                    alert('Please select a day.');
                    return;
                }
                if (!activeRecipeId) return;

                // Default to "current" week
                const currentWeek = 'current';
                const key = `${currentWeek}-${day}`;

                if (!mealPlan[key]) {
                    mealPlan[key] = [];
                }

                if (!mealPlan[key].includes(activeRecipeId)) {
                    mealPlan[key].push(activeRecipeId);
                    saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                    alert('Added to meal plan!');
                    // Optionally refresh if view is currently meal plan, though modal is open
                } else {
                    alert('This recipe is already on the meal plan for that day.');
                }
            });

            // --- Recipe Editing ---
            function openRecipeEdit(recipeId) {
                const recipe = allRecipes.find(r => r.id === recipeId);
                if (!recipe) return;

                // Fill the form with recipe data
                document.getElementById('recipeTitle').value = recipe.title || '';
                document.getElementById('recipeCategory').value = recipe.category || '';
                document.getElementById('originalServings').value = recipe.originalServings || 1;
                document.getElementById('ingredients').value = recipe.ingredients ? recipe.ingredients.join('\n') : '';
                document.getElementById('instructions').value = recipe.instructions ? recipe.instructions.join('\n') : '';
                
                // Set rating stars
                renderStars(addRecipeRatingStars, recipe.rating || 0);
                
                // Set image
                currentRecipeImageData = recipe.imageData || null;
                
                // Set editing mode
                editingRecipeIdInput.value = recipeId;
                addRecipeModalTitle.textContent = 'Edit Recipe';
                saveRecipeBtn.textContent = 'Update Recipe';
                
                openModal(addRecipeModalOverlay);
            }

            function resetRecipeForm() {
                recipeForm.reset();
                renderStars(addRecipeRatingStars, 0);
                currentRecipeImageData = null;
                editingRecipeIdInput.value = '';
                addRecipeModalTitle.textContent = 'Add a New Recipe';
                saveRecipeBtn.textContent = 'Save Recipe';
            }

            // --- Recipe Detail Functions ---
            function openRecipeDetail(recipeId) {
                const recipe = allRecipes.find(r => r.id === recipeId);
                if (!recipe) return;

                activeRecipeId = recipeId;
                detailRecipeTitle.textContent = recipe.title;
                recipeDetailModalContent.innerHTML = '';

                detailRecipeCategory.textContent = recipe.category || 'N/A';
                renderStars(detailRecipeRating, recipe.rating || 0);

                // Reset meal plan dropdown
                addToMealPlanDay.value = "";

                detailOriginalServings.textContent = recipe.originalServings || 1;
                desiredServingsInput.value = recipe.originalServings || 1;
                desiredServingsInput.oninput = () => updateScaledIngredients(recipe);

                const ingredientsSection = document.createElement('div');
                ingredientsSection.classList.add('detail-section', 'ingredients-section');
                ingredientsSection.innerHTML = `<h3>Ingredients</h3><ul id="scaledIngredientsList"></ul>`;
                recipeDetailModalContent.appendChild(ingredientsSection);

                const instructionsSection = document.createElement('div');
                instructionsSection.classList.add('detail-section', 'instructions-section');
                instructionsSection.innerHTML = `<h3>Instructions</h3><ol id="recipeInstructionsList"></ol>`;
                const instructionsList = instructionsSection.querySelector('ol');

                recipe.instructions.forEach((item) => {
                    const li = document.createElement('li');
                    li.classList.add('instruction-item');
                    const textSpan = document.createElement('span');
                    textSpan.textContent = item;
                    li.appendChild(textSpan);

                    const timeMatch = item.match(/(\d+(?:\.\d+)?)\s*(?:minute|minutes|min|hour|hr)s?/i);
                    if (timeMatch) {
                        let duration = parseFloat(timeMatch[1]);
                        if (timeMatch[0].toLowerCase().includes('hour') || timeMatch[0].toLowerCase().includes('hr')) {
                            duration *= 60;
                        }
                        const timerBtn = document.createElement('button');
                        timerBtn.classList.add('timer-btn');
                        timerBtn.textContent = `Start ${duration} min timer`;
                        timerBtn.addEventListener('click', () => startTimer(duration, item));
                        li.appendChild(timerBtn);
                    }
                    instructionsList.appendChild(li);
                });
                recipeDetailModalContent.appendChild(instructionsSection);

                recipeNotesTextarea.value = recipe.notes || '';
                recipeNotesTextarea.oninput = () => {
                    const currentRecipe = allRecipes.find(r => r.id === activeRecipeId);
                    if (currentRecipe) {
                        currentRecipe.notes = recipeNotesTextarea.value;
                        saveData(RECIPES_STORAGE_KEY, allRecipes);
                    }
                };

                updateScaledIngredients(recipe);
                openModal(recipeDetailModalOverlay);
            }

            // Regex for parsing quantities in ingredients
            const quantityRegex = /^(\d+(?:\.\d+)?|\d+\/\d+)\s*(.*)/;

            function parseQuantity(text) {
                const match = text.match(quantityRegex);
                if (match) {
                    let value = match[1];
                    if (value.includes('/')) {
                        // Safer fraction parsing
                        const parts = value.split('/');
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1]) && parseFloat(parts[1]) !== 0) {
                            value = parseFloat(parts[0]) / parseFloat(parts[1]);
                        } else {
                            // Fallback for unrecognized fraction format (e.g. "1/2 cup sugar" might parse "1/2" as a string)
                            value = parseFloat(value);
                        }
                    } else {
                        value = parseFloat(value);
                    }
                    const rest = match[3];
                    return { quantity: value, rest: rest.trim() };
                }
                return { quantity: null, rest: text.trim() };
            }

            function updateScaledIngredients(recipe) {
                const originalServings = recipe.originalServings || 1;
                const desiredServings = parseFloat(desiredServingsInput.value) || 1;
                const scaleFactor = desiredServings / originalServings;

                const ingredientsList = document.getElementById('scaledIngredientsList');
                if (!ingredientsList) return;

                ingredientsList.innerHTML = '';

                recipe.ingredients.forEach((originalItem) => {
                    const li = document.createElement('li');
                    li.classList.add('ingredient-item');
                    li.addEventListener('click', () => li.classList.toggle('checked'));

                    const parsed = parseQuantity(originalItem);
                    if (parsed.quantity !== null && typeof parsed.quantity === 'number' && !isNaN(parsed.quantity)) {
                        const scaledQuantity = parsed.quantity * scaleFactor;
                        let displayQuantity;

                        if (Number.isInteger(parsed.quantity) && Number.isInteger(scaledQuantity)) {
                            displayQuantity = scaledQuantity;
                        } else {
                            displayQuantity = Math.round(scaledQuantity * 100) / 100;
                            if (displayQuantity % 1 === 0) displayQuantity = Math.round(displayQuantity);
                        }
                        li.textContent = `${displayQuantity} ${parsed.rest}`;
                    } else {
                        li.textContent = originalItem;
                    }
                    ingredientsList.appendChild(li);
                });
            }

            function startTimer(durationMinutes, instructionText) {
                if (currentTimer) {
                    if (!confirm("A timer is already running. Do you want to stop it and start a new one?")) {
                        return;
                    }
                    clearInterval(currentTimer);
                    timerIndicator.style.display = 'none';
                    currentTimer = null;
                }

                let secondsRemaining = Math.floor(durationMinutes * 60);

                if (secondsRemaining <= 0) {
                    alert(`Timer for "${instructionText}" could not be started as the duration is too short or invalid.`);
                    return;
                }

                timerIndicator.style.display = 'block';
                timerIndicator.textContent = `Timer for "${instructionText.substring(0, Math.min(instructionText.length, 30))}...": ${formatTime(secondsRemaining)}`;

                currentTimer = setInterval(() => {
                    secondsRemaining--;
                    if (secondsRemaining <= 0) {
                        clearInterval(currentTimer);
                        timerIndicator.style.display = 'none';
                        alert(`Time's up! For: "${instructionText}"`);
                        currentTimer = null;
                    } else {
                        timerIndicator.textContent = `Timer for "${instructionText.substring(0, Math.min(instructionText.length, 30))}...": ${formatTime(secondsRemaining)}`;
                    }
                }, 1000);
            }

            function formatTime(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function deleteRecipe(event) {
                const recipeIdToDelete = parseInt(event.target.dataset.recipeId);
                const recipeIndex = allRecipes.findIndex(recipe => recipe.id === recipeIdToDelete);

                if (recipeIndex > -1) {
                    if (confirm(`Are you sure you want to delete "${allRecipes[recipeIndex].title}"?`)) {
                        // Remove from favorites if it was favorited
                        const favIndex = favorites.indexOf(recipeIdToDelete);
                        if (favIndex > -1) {
                            favorites.splice(favIndex, 1);
                            saveData(FAVORITES_STORAGE_KEY, favorites);
                        }
                        
                        // Remove from meal plan
                        for (const key in mealPlan) {
                            const index = mealPlan[key].indexOf(recipeIdToDelete);
                            if (index > -1) {
                                mealPlan[key].splice(index, 1);
                                if (mealPlan[key].length === 0) {
                                    delete mealPlan[key];
                                }
                            }
                        }
                        saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);
                        
                        // Remove the recipe
                        allRecipes.splice(recipeIndex, 1);
                        saveData(RECIPES_STORAGE_KEY, allRecipes);
                        
                        // Refresh views
                        if (currentView === 'recipes') {
                            renderRecipes();
                        } else if (currentView === 'favorites') {
                            renderFavorites();
                        } else if (currentView === 'mealPlan') {
                            renderMealPlan();
                        }
                    }
                }
            }

            // --- Event Listeners ---

            recipeImageFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    currentRecipeImageData = null;
                    return;
                }

                if (file.size > 250 * 1024) {
                    alert('Warning: This image is larger than 250KB. Storing large images in localStorage can cause issues. Consider using a smaller image or an external URL.');
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    currentRecipeImageData = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            recipeForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const title = document.getElementById('recipeTitle').value.trim();
                const category = recipeCategorySelect.value;
                const originalServings = parseInt(originalServingsInput.value);
                const rating = parseInt(addRecipeRatingStars.dataset.rating);
                const ingredients = document.getElementById('ingredients').value.trim().split('\n').filter(line => line.trim() !== '');
                const instructions = document.getElementById('instructions').value.trim().split('\n').filter(line => line.trim() !== '');
                const editingRecipeId = editingRecipeIdInput.value ? parseInt(editingRecipeIdInput.value) : null;

                if (!title || !category || ingredients.length === 0 || instructions.length === 0 || isNaN(originalServings) || originalServings < 1) {
                    alert('Please fill in Recipe Title, Category, Original Servings, Ingredients, and Instructions fully.');
                    return;
                }
                if (category === '' || recipeCategorySelect.selectedIndex === -1 || recipeCategorySelect.options[recipeCategorySelect.selectedIndex].disabled) {
                     alert('Please select or add a valid category.');
                     return;
                }

                if (editingRecipeId) {
                    // Update existing recipe
                    const recipeIndex = allRecipes.findIndex(r => r.id === editingRecipeId);
                    if (recipeIndex > -1) {
                        allRecipes[recipeIndex] = {
                            ...allRecipes[recipeIndex],
                            title,
                            imageData: currentRecipeImageData || allRecipes[recipeIndex].imageData,
                            category,
                            originalServings,
                            rating,
                            ingredients,
                            instructions
                        };
                    }
                } else {
                    // Create new recipe
                    const newRecipe = {
                        id: Date.now() + Math.floor(Math.random() * 100000),
                        title,
                        imageData: currentRecipeImageData,
                        category,
                        originalServings,
                        rating,
                        ingredients,
                        instructions,
                        notes: ''
                    };
                    allRecipes.push(newRecipe);
                }

                saveData(RECIPES_STORAGE_KEY, allRecipes);
                resetRecipeForm();
                closeModal(addRecipeModalOverlay);
                
                // Refresh current view
                if (currentView === 'recipes') {
                    renderRecipes();
                } else if (currentView === 'favorites') {
                    renderFavorites();
                }
            });

            sortSelect.addEventListener('change', () => {
                if (currentView === 'recipes') renderRecipes();
            });
            
            filterCategorySelect.addEventListener('change', (event) => {
                currentFilterCategory = event.target.value;
                if (currentView === 'recipes') renderRecipes();
            });
            
            recipeSearchInput.addEventListener('input', (event) => {
                currentSearchTerm = event.target.value;
                if (currentView === 'recipes') renderRecipes();
            });

            // --- JSON Import/Export ---
            exportJsonBtn.addEventListener('click', () => {
                const dataToExport = {
                    recipes: allRecipes,
                    categories: allCategories,
                    favorites: favorites,
                    mealPlan: mealPlan
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'beckner_recipes.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            function processImportedJson(importedData, clearAndOverwrite = false) {
                if (importedData.recipes && Array.isArray(importedData.recipes) &&
                    importedData.categories && Array.isArray(importedData.categories)) {

                    if (clearAndOverwrite) {
                        // Clear all and import
                        allRecipes = importedData.recipes.map(rec => ({...rec, id: Date.now() + Math.floor(Math.random() * 100000)}));
                        allCategories = importedData.categories;
                        favorites = importedData.favorites || [];
                        mealPlan = importedData.mealPlan || {};
                        alert('All existing data cleared. Recipes, categories, favorites, and meal plan imported successfully!');
                    } else {
                        // Merge with existing data
                        const confirmMessage = "Imported recipes found. Do you want to:\n\n" +
                                               "OK: Merge with existing recipes (new IDs generated for imported recipes to avoid conflicts, duplicates by title possible)\n" +
                                               "Cancel: Overwrite all existing recipes";

                        if (confirm(confirmMessage)) {
                            // Merge recipes
                            const newRecipesWithIds = importedData.recipes.map(rec => ({...rec, id: Date.now() + Math.floor(Math.random() * 100000)}));
                            allRecipes = [...allRecipes, ...newRecipesWithIds];
                            
                            // Merge favorites
                            favorites = [...new Set([...favorites, ...(importedData.favorites || [])])];
                            
                            // Merge meal plan
                            mealPlan = {...mealPlan, ...(importedData.mealPlan || {})};
                        } else {
                            // Overwrite
                            allRecipes = importedData.recipes.map(rec => ({...rec, id: Date.now() + Math.floor(Math.random() * 100000)}));
                            favorites = importedData.favorites || [];
                            mealPlan = importedData.mealPlan || {};
                        }
                        
                        // Merge categories
                        allCategories = [...new Set([...allCategories, ...importedData.categories])];
                        allCategories.sort();
                        
                        alert('Recipes, categories, favorites, and meal plan imported successfully!');
                    }

                    saveData(RECIPES_STORAGE_KEY, allRecipes);
                    saveData(CATEGORIES_STORAGE_KEY, allCategories);
                    saveData(FAVORITES_STORAGE_KEY, favorites);
                    saveData(MEAL_PLAN_STORAGE_KEY, mealPlan);

                    renderCategoryDropdowns();
                    
                    // Refresh current view
                    if (currentView === 'recipes') {
                        renderRecipes();
                    } else if (currentView === 'favorites') {
                        renderFavorites();
                    } else if (currentView === 'mealPlan') {
                        renderMealPlan();
                    }
                } else {
                    alert('Invalid JSON file format. Expected "recipes" and "categories" arrays.');
                }
            }

            // "Merge with JSON" button
            importJsonBtn.addEventListener('click', () => {
                importFileInput.dataset.importMode = 'merge';
                importFileInput.click();
            });

            // "Clear All & Import JSON" button
            clearAndImportJsonBtn.addEventListener('click', () => {
                if (!confirm("Are you sure you want to clear ALL existing recipes, categories, favorites, and meal plan and replace them with imported data? This action cannot be undone.")) {
                    return;
                }
                importFileInput.dataset.importMode = 'clearAndOverwrite';
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const importMode = event.target.dataset.importMode;

                        if (importMode === 'clearAndOverwrite') {
                            processImportedJson(importedData, true);
                        } else {
                            processImportedJson(importedData, false);
                        }

                    } catch (error) {
                        alert('Error parsing JSON file: ' + error.message);
                        console.error('JSON parsing error:', error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
                delete event.target.dataset.importMode;
            });

            // --- View Toggle Event Listeners ---
            recipesViewBtn.addEventListener('click', () => setActiveView('recipes'));
            mealPlanViewBtn.addEventListener('click', () => {
                setActiveView('mealPlan');
                // Re-render when switching to ensure any new additions from modal are shown
                renderMealPlan();
            });
            favoritesViewBtn.addEventListener('click', () => setActiveView('favorites'));

            // --- Modal Event Listeners ---
            openAddRecipeModalBtn.addEventListener('click', () => {
                resetRecipeForm();
                openModal(addRecipeModalOverlay);
            });
            
            closeAddRecipeModalBtn.addEventListener('click', () => closeModal(addRecipeModalOverlay));
            addRecipeModalOverlay.addEventListener('click', (event) => {
                if (event.target === addRecipeModalOverlay) closeModal(addRecipeModalOverlay);
            });

            closeRecipeDetailModalBtn.addEventListener('click', () => {
                const recipe = allRecipes.find(r => r.id === activeRecipeId);
                if (recipe) {
                    recipe.notes = recipeNotesTextarea.value;
                    saveData(RECIPES_STORAGE_KEY, allRecipes);
                }
                activeRecipeId = null;
                closeModal(recipeDetailModalOverlay);
            });
            
            recipeDetailModalOverlay.addEventListener('click', (event) => {
                if (event.target === recipeDetailModalOverlay) {
                    const recipe = allRecipes.find(r => r.id === activeRecipeId);
                    if (recipe) {
                        recipe.notes = recipeNotesTextarea.value;
                        saveData(RECIPES_STORAGE_KEY, allRecipes);
                    }
                    activeRecipeId = null;
                    closeModal(recipeDetailModalOverlay);
                }
            });

            // Edit recipe button in detail modal
            editRecipeBtn.addEventListener('click', () => {
                if (activeRecipeId) {
                    closeModal(recipeDetailModalOverlay);
                    openRecipeEdit(activeRecipeId);
                }
            });

            // Print button in detail modal
            printRecipeBtn.addEventListener('click', () => window.print());

            // --- Initial Setup ---
            renderCategoryDropdowns();
            setActiveView('recipes'); // Start with recipes view
            
            // Make sure all recipes have IDs (for backward compatibility)
            let needsSave = false;
            allRecipes.forEach(recipe => {
                if (!recipe.id) {
                    recipe.id = Date.now() + Math.floor(Math.random() * 100000);
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                saveData(RECIPES_STORAGE_KEY, allRecipes);
            }
        });
    </script>
</body>
</html>
